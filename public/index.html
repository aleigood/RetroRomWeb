<!doctype html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
        />
        <meta name="theme-color" content="#101014" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
        <link rel="icon" href="data:," />

        <title>RetroRom Hub</title>
        <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/vant@4/lib/index.css" />
        <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet" />
        <style>
            :root {
                --bg-body: #101014;
                --bg-card: #1c1c22;
                --text-main: #f2f2f2;
                --text-sub: #8a8a9b;
                --primary: #705df2;
                --accent: #ff4757;
                --nav-height: 56px;

                /* 空状态样式优化 */
                --van-empty-description-color: #666 !important;
                --van-empty-description-padding: 0 !important;
                --van-empty-image-size: auto !important;
            }

            * {
                scrollbar-width: none !important;
                -ms-overflow-style: none !important;
            }
            ::-webkit-scrollbar {
                display: none !important;
                width: 0 !important;
                height: 0 !important;
            }

            html {
                height: 100%;
                overflow: hidden;
                background: var(--bg-body);
            }

            body {
                height: 100%;
                overflow: hidden;
                background: var(--bg-body);
                color: var(--text-main);
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                margin: 0;
                -webkit-tap-highlight-color: transparent;
            }

            #app {
                height: 100%;
                width: 100%;
                position: relative;
                overflow: hidden;
            }

            /* === 基础组件样式 === */
            .navbar {
                background: rgba(28, 28, 34, 0.5);
                backdrop-filter: blur(20px);
                height: var(--nav-height);
                display: flex;
                align-items: center;
                padding: 0 16px;
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                z-index: 500;
                border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            }
            .nav-title {
                font-weight: 800;
                font-size: 18px;
                flex: 1;
                text-align: center;
                letter-spacing: 0.5px;
            }
            .nav-btn {
                font-size: 24px;
                padding: 8px;
                color: var(--text-main);
                cursor: pointer;
                transition: opacity 0.2s;
            }
            .nav-btn:active {
                opacity: 0.6;
            }

            .page-container {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                box-sizing: border-box;
                padding-top: calc(var(--nav-height) + 16px);
                padding-bottom: 40px;
                padding-left: 16px;
                padding-right: 16px;
                background: var(--bg-body);
                overflow-x: hidden;
                overscroll-behavior: none;
            }

            /* === 弹窗样式修正 === */
            .van-popup.van-dialog {
                background: #25252b !important;
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 16px !important;
                overflow: hidden;
                box-shadow: 0 25px 60px -10px rgba(0, 0, 0, 0.9) !important;
            }
            .van-dialog__header {
                color: #fff !important;
                padding-top: 24px;
                font-weight: 800;
            }
            .van-dialog__message {
                color: #ccc !important;
                font-size: 14px;
                line-height: 1.6;
                padding: 24px !important;
                text-align: center;
            }
            .van-dialog .van-checkbox__label {
                color: #e0e0e0 !important;
                font-size: 15px;
            }

            .van-dialog__footer {
                padding: 0 !important;
                display: flex !important;
                width: 100% !important;
                gap: 0 !important;
            }
            .van-hairline--top::after,
            .van-hairline--left::after {
                border: none !important;
            }
            .van-dialog__button {
                flex: 1 !important;
                border-radius: 0 !important;
                margin: 0 !important;
                height: 48px !important;
                border: none !important;
            }
            .van-dialog__cancel {
                background: #3a3a44 !important;
                color: #fff !important;
            }
            .van-dialog__confirm {
                background: linear-gradient(135deg, #ff4757, #ff6b81) !important;
                color: white !important;
            }

            /* === 搜索框重构样式 === */
            .van-search__content {
                background-color: #25252b !important;
                border: 1px solid rgba(255, 255, 255, 0.1);
                align-items: center;
            }
            .van-search__field .van-field__control {
                color: #f2f2f2 !important;
                font-weight: 500;
            }
            .van-search__field .van-field__left-icon {
                color: #666 !important;
                margin-right: 4px !important;
                display: flex;
                align-items: center;
            }
            input::placeholder {
                color: #555 !important;
            }

            .custom-clear-btn {
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 18px;
                color: #666;
                padding: 0 10px;
                margin-right: 0px;
                cursor: pointer;
                transition: color 0.2s;
            }
            .custom-clear-btn:active {
                color: #999;
            }

            .van-empty__image {
                width: auto !important;
                height: auto !important;
                margin-bottom: 16px !important;
            }

            /* === 索引栏 & 滚动条 === */
            .van-index-bar__sidebar {
                display: none !important;
            }

            .index-hint {
                position: fixed;
                right: 4px;
                width: 4px;
                height: 40px;
                background: rgba(255, 255, 255, 0.6);
                border-radius: 4px;
                z-index: 2500;
                pointer-events: auto;
                transition: opacity 0.3s;
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
                opacity: 0.1;
                touch-action: none;
            }
            .index-hint::before {
                content: '';
                position: absolute;
                top: -10px;
                bottom: -10px;
                left: -30px;
                right: -10px;
                background: transparent;
            }
            .index-hint::after {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 2px;
                height: 16px;
                background: rgba(0, 0, 0, 0.3);
                border-radius: 2px;
            }

            .index-hint.active-scroll {
                opacity: 0.8;
            }
            body.touching-sidebar .index-hint {
                opacity: 0;
            }

            .custom-sidebar {
                position: fixed !important;
                right: 0 !important;
                z-index: 2000 !important;
                width: 30px;
                background: transparent !important;
                box-shadow: none !important;
                opacity: 0;
                top: 70px;
                bottom: auto !important;
                height: auto !important;
                transform: translateY(0) !important;
                display: flex !important;
                flex-direction: column !important;
                justify-content: center !important;
                touch-action: none;
                user-select: none;
                -webkit-user-select: none;
                transition: opacity 0.2s;
                pointer-events: none !important;
            }

            body.touching-sidebar .custom-sidebar {
                background: rgba(0, 0, 0, 0.7) !important;
                border-top-left-radius: 16px;
                border-bottom-left-radius: 16px;
                opacity: 1 !important;
                padding: 8px 0;
                pointer-events: auto !important;
            }

            .custom-index-char {
                padding: 2px 0 !important;
                text-align: center;
                color: rgba(255, 255, 255, 0.6) !important;
                font-size: 10px;
                font-weight: 700 !important;
                line-height: 1.4;
                transition:
                    transform 0.1s,
                    color 0.1s;
            }
            body.touching-sidebar .custom-index-char.active {
                color: #fff !important;
                transform: scale(1.6);
            }

            .side-bubble {
                position: fixed;
                right: 45px;
                width: 50px;
                height: 50px;
                background: var(--primary);
                color: #fff;
                border-radius: 50% 50% 0 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 28px;
                font-weight: 900;
                box-shadow: -4px 4px 15px rgba(0, 0, 0, 0.4);
                pointer-events: none;
                z-index: 3000;
                opacity: 0;
                transform: translateY(-50%) rotate(-45deg) scale(0.5);
                transition:
                    opacity 0.1s,
                    transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            }
            .side-bubble.visible {
                opacity: 1;
                transform: translateY(-50%) rotate(-45deg) scale(1);
            }
            .side-bubble span {
                transform: rotate(45deg);
                display: block;
            }

            .van-index-anchor {
                background: transparent !important;
                color: var(--primary);
                font-weight: 800;
                font-size: 18px;
                padding: 10px 0 10px 4px !important;
            }

            .virtual-wrapper {
                position: relative;
                width: 100%;
            }
            .virtual-row {
                position: absolute;
                left: 0;
                width: 100%;
                display: grid;
                gap: 16px;
            }
            .virtual-anchor-row {
                display: flex;
                align-items: center;
                color: var(--primary);
                font-weight: 800;
                font-size: 18px;
                padding-left: 4px;
            }

            .slide-left-enter-active,
            .slide-left-leave-active,
            .slide-right-enter-active,
            .slide-right-leave-active {
                transition:
                    transform 0.3s cubic-bezier(0.25, 0.1, 0.25, 1),
                    opacity 0.3s ease;
                z-index: 10;
            }
            .slide-left-enter-from {
                transform: translateX(100%);
                z-index: 20;
            }
            .slide-left-enter-to {
                transform: translateX(0);
                z-index: 20;
            }
            .slide-left-leave-from {
                transform: translateX(0);
                opacity: 1;
            }
            .slide-left-leave-to {
                transform: translateX(-25%);
                opacity: 0.5;
            }
            .slide-right-enter-from {
                transform: translateX(-25%);
                opacity: 0.5;
            }
            .slide-right-enter-to {
                transform: translateX(0);
                opacity: 1;
            }
            .slide-right-leave-from {
                transform: translateX(0);
                z-index: 20;
            }
            .slide-right-leave-to {
                transform: translateX(100%);
                z-index: 20;
            }

            .sys-group {
                display: flex;
                flex-direction: column;
                gap: 20px;
                padding-bottom: 20px;
            }
            .sys-card {
                background: var(--bg-card);
                border-radius: 20px;
                overflow: hidden;
                border: 1px solid rgba(255, 255, 255, 0.05);
                box-shadow: 0 15px 35px -10px rgba(0, 0, 0, 0.3);
                display: flex;
                height: 140px;
                position: relative;
                transition: transform 0.2s;
                transform: translateZ(0);
            }
            .sys-card:active {
                transform: scale(0.96);
            }
            .sys-visual {
                width: 120px;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
                position: relative;
                overflow: hidden;
                background: linear-gradient(135deg, #2d3436, #000);
            }
            .sys-visual::after {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), transparent);
            }
            .sys-abbr {
                font-size: 28px;
                font-weight: 900;
                color: rgba(255, 255, 255, 0.95);
                text-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                z-index: 2;
                text-transform: uppercase;
            }
            .sys-count-badge {
                position: absolute;
                bottom: 6px;
                right: 6px;
                font-size: 9px;
                color: rgba(255, 255, 255, 0.9);
                font-weight: 700;
                z-index: 2;
                background: rgba(0, 0, 0, 0.4);
                padding: 1px 5px;
                border-radius: 4px;
            }
            .sys-content {
                flex: 1;
                padding: 18px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                min-width: 0;
            }
            .sys-name {
                font-size: 19px;
                font-weight: 800;
                color: #fff;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                margin-bottom: 6px;
            }
            .sys-meta {
                font-size: 12px;
                color: var(--primary);
                margin-bottom: 10px;
                font-weight: 600;
            }
            .sys-desc {
                font-size: 13px;
                color: var(--text-sub);
                display: -webkit-box;
                -webkit-line-clamp: 2;
                line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
                line-height: 1.5;
            }

            .intro-header {
                margin: 0 0 20px 0;
                padding: 24px;
                border-radius: 24px;
                color: #fff;
                box-shadow: 0 12px 30px -8px rgba(0, 0, 0, 0.4);
                position: relative;
                overflow: hidden;
                background-size: 200% 200% !important;
                animation: gradientMove 8s ease infinite;
            }
            .intro-bg-icon {
                position: absolute;
                right: -25px;
                bottom: -35px;
                font-size: 160px;
                opacity: 0.12;
                transform: rotate(-15deg);
            }
            .intro-title {
                font-size: 24px;
                font-weight: 900;
                margin-bottom: 10px;
                text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                position: relative;
                z-index: 2;
            }
            .intro-text {
                font-size: 13px;
                line-height: 1.6;
                opacity: 0.95;
                position: relative;
                z-index: 2;
                font-weight: 500;
            }

            .game-card {
                background: var(--bg-card);
                border-radius: 14px;
                overflow: hidden;
                position: relative;
                aspect-ratio: 3/4;
                border: 1px solid rgba(255, 255, 255, 0.05);
                box-shadow: 0 8px 20px -6px rgba(0, 0, 0, 0.4);
                transform: translateZ(0);
                will-change: transform;
            }
            .game-card:active {
                transform: scale(0.95);
            }
            .thumb-box {
                width: 100%;
                height: 100%;
                position: relative;
                background: #15151a;
            }
            .thumb-bg {
                position: absolute;
                width: 100%;
                height: 100%;
                top: 0;
                left: 0;
                transform: scale(1.2);
                object-fit: cover;
                filter: blur(15px) brightness(0.4) saturate(1.2);
                z-index: 1;
                pointer-events: none;
            }
            .thumb-img {
                position: absolute;
                width: 100%;
                height: 100%;
                object-fit: contain;
                z-index: 2;
            }
            .lazy-img {
                opacity: 0;
                transition: opacity 0.4s ease-out;
                will-change: opacity;
            }
            .lazy-img.loaded {
                opacity: 1;
            }
            .no-img {
                width: 100%;
                height: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                background: #18181c;
                color: #444;
            }

            .ver-badge {
                position: absolute;
                top: 8px;
                right: 8px;
                z-index: 5;
                background: rgba(0, 0, 0, 0.75);
                backdrop-filter: blur(4px);
                color: #fff;
                font-size: 9px;
                padding: 3px 8px;
                border-radius: 6px;
                border: 1px solid rgba(255, 255, 255, 0.15);
                font-weight: bold;
            }
            .game-info-overlay {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                z-index: 5;
                background: linear-gradient(to top, rgba(0, 0, 0, 0.95) 10%, rgba(0, 0, 0, 0.6) 60%, transparent);
                padding: 30px 8px 10px;
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            .g-title {
                font-size: 12px;
                color: #fff;
                text-align: center;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                font-weight: 700;
                width: 100%;
                margin-top: 0;
            }
            .g-year {
                font-size: 10px;
                color: #bbb;
                text-align: center;
                margin-bottom: 2px;
            }
            .g-rating {
                height: 12px;
                line-height: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                margin-bottom: 2px;
            }

            .detail-popup {
                background: #121212 !important;
                display: block;
            }
            .detail-flex-wrapper {
                height: 100%;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }
            .detail-top-bar {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 60px;
                display: flex;
                align-items: center;
                justify-content: center;
                background: transparent;
                z-index: 20;
                border-bottom: none;
                pointer-events: none;
            }
            .detail-close-btn {
                width: 32px;
                height: 32px;
                background: rgba(0, 0, 0, 0.4);
                backdrop-filter: blur(10px);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                border: 1px solid rgba(255, 255, 255, 0.1);
                pointer-events: auto;
                transition: background 0.2s;
            }
            .detail-close-btn:active {
                background: rgba(255, 255, 255, 0.3);
            }
            .detail-scroll-container {
                flex: 1;
                overflow-y: auto;
                height: auto;
                position: relative;
                overflow-x: hidden;
            }
            .swipe-area {
                height: 55vh;
                background: #000;
                position: relative;
                flex-shrink: 0;
            }
            .swipe-inner {
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                position: relative;
                overflow: hidden;
                padding-top: 60px;
                box-sizing: border-box;
            }
            .swipe-bg {
                position: absolute;
                width: 100%;
                height: 100%;
                top: 0;
                left: 0;
                transform: scale(1.2);
                object-fit: cover;
                filter: blur(40px) brightness(0.3);
                z-index: 1;
            }
            .swipe-img {
                width: 100%;
                height: 100%;
                position: relative;
                z-index: 2;
                object-fit: contain;
            }
            .pixelated {
                image-rendering: pixelated;
                image-rendering: crisp-edges;
            }
            .crt-lines {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(to bottom, rgba(255, 255, 255, 0) 50%, rgba(0, 0, 0, 0.25) 50%);
                background-size: 100% 3px;
                z-index: 5;
                pointer-events: none;
                opacity: 0.6;
            }
            .thumb-strip {
                display: flex;
                gap: 12px;
                padding: 20px 16px;
                background: #18181c;
                overflow-x: auto;
                border-bottom: 1px solid rgba(255, 255, 255, 0.05);
                flex-shrink: 0;
            }
            .ts-item {
                width: 64px;
                height: 64px;
                border-radius: 10px;
                overflow: hidden;
                position: relative;
                flex-shrink: 0;
                border: 2px solid transparent;
                opacity: 0.5;
                transition: all 0.2s;
            }
            .ts-item.active {
                border-color: var(--primary);
                opacity: 1;
                transform: scale(1.05);
                box-shadow: 0 0 15px rgba(112, 93, 242, 0.3);
            }
            .ts-img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }
            .ts-video-icon {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 24px;
                color: rgba(255, 255, 255, 0.8);
                z-index: 10;
            }
            .d-body {
                padding: 24px;
            }
            .d-marquee-box {
                position: relative;
                display: flex;
                justify-content: center;
                align-items: center;
                margin-top: 80px;
                margin-bottom: 80px;
                border: none;
                box-shadow: none;
                min-height: 100px;
                background: transparent;
            }
            .d-marquee-bg {
                position: absolute;
                top: 50%;
                left: 50%;
                width: 120vw;
                height: 120vw;
                transform: translate(-50%, -50%);
                object-fit: cover;
                filter: blur(40px) opacity(0.6);
                z-index: -1;
                mask-image: radial-gradient(circle, black 20%, transparent 70%);
                -webkit-mask-image: radial-gradient(circle, black 20%, transparent 70%);
                pointer-events: none;
            }
            .d-marquee-img {
                position: relative;
                max-width: 85%;
                max-height: 120px;
                width: auto;
                object-fit: contain;
                z-index: 1;
                filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.4));
            }
            .d-title {
                font-size: 26px;
                font-weight: 800;
                margin-bottom: 16px;
                color: #fff;
            }
            .d-tags {
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
                margin-bottom: 24px;
            }
            .tag {
                background: rgba(255, 255, 255, 0.1);
                padding: 6px 12px;
                border-radius: 8px;
                font-size: 12px;
                color: #ddd;
                display: flex;
                align-items: center;
                gap: 4px;
            }
            .d-desc {
                font-size: 15px;
                line-height: 1.7;
                color: #a0a0b0;
                margin-bottom: 30px;
                white-space: pre-wrap;
            }

            /* === 修复布局问题 === */
            .ver-item {
                background: #25252b;
                border-radius: 16px;
                padding: 16px;
                margin-bottom: 12px;
                border: 1px solid rgba(255, 255, 255, 0.05);
                /* 关键修改：垂直排列 */
                display: flex;
                flex-direction: column;
                align-items: stretch; /* 让子元素占满宽度 */
                gap: 12px; /* 上下间距 */
            }
            .v-file {
                font-size: 14px;
                color: #f2f2f2;
                /* 允许长文件名换行，不再截断 */
                white-space: normal;
                word-break: break-all;
                line-height: 1.4;
            }
            .ver-btn-group {
                /* 按钮组容器：右对齐 */
                display: flex;
                justify-content: flex-end;
                gap: 10px;
            }
            .ver-item.selected {
                border-color: var(--primary);
                background: #2d2d36;
            }

            .dl-btn {
                background: linear-gradient(135deg, #705df2, #a29bfe);
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 24px;
                font-size: 13px;
                font-weight: 700;
                display: flex;
                align-items: center;
                gap: 6px;
            }
            .play-btn {
                background: linear-gradient(135deg, #2ecc71, #27ae60);
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 24px;
                font-size: 13px;
                font-weight: 700;
                display: flex;
                align-items: center;
                gap: 6px;
            }

            .log-popup {
                background: #1c1c22 !important;
                color: #ccc;
                font-family: monospace;
                padding: 0;
                max-height: 70vh;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }
            .log-header {
                padding: 16px 20px;
                background: rgba(255, 255, 255, 0.05);
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            }
            .log-content {
                flex: 1;
                overflow-y: auto;
                padding: 20px;
            }
            .log-item {
                border-bottom: 1px solid rgba(255, 255, 255, 0.05);
                padding: 6px 0;
                font-size: 12px;
            }

            /* === 模拟器覆盖层样式修正 (布局重构) === */
            #emulator-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: #000;
                z-index: 9999;
                display: flex;
                flex-direction: column; /* 垂直排列：顶部栏 -> 游戏 -> 底部占位 */
            }

            /* 1. 顶部控制栏 */
            .emu-top-bar {
                height: 60px;
                width: 100%;
                background: #101014; /* 略亮的背景色 */
                display: flex;
                justify-content: center; /* 按钮居中 */
                align-items: center;
                gap: 30px;
                z-index: 10002;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                flex-shrink: 0; /* 防止被压缩 */
            }

            /* 2. 游戏画面区域 */
            #game {
                width: 100%;
                flex: 1; /* 自动填满剩余高度 */
                background: #000;
            }

            /* 3. 底部占位区块 (10%) */
            .emu-bottom-spacer {
                height: 10vh; /* 占屏幕高度的 10% */
                width: 100%;
                background: #000;
                flex-shrink: 0; /* 固定高度，不压缩 */
                z-index: 10000;
            }

            /* 按钮样式 */
            .emu-btn {
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.15);
                color: rgba(255, 255, 255, 0.9);
                padding: 8px 24px;
                border-radius: 20px;
                font-weight: 600;
                font-size: 13px;
                display: flex;
                align-items: center;
                gap: 6px;
                cursor: pointer;
                transition: all 0.2s;
                user-select: none;
                -webkit-user-select: none;
            }
            .emu-btn:active {
                background: rgba(255, 255, 255, 0.25);
                transform: scale(0.96);
            }
            .emu-btn.danger {
                background: rgba(235, 77, 75, 0.2);
                border-color: rgba(235, 77, 75, 0.4);
                color: #ffcccc;
            }
            .emu-btn.danger:active {
                background: rgba(235, 77, 75, 0.4);
            }

            @keyframes gradientMove {
                0% {
                    background-position: 0% 50%;
                }
                50% {
                    background-position: 100% 50%;
                }
                100% {
                    background-position: 0% 50%;
                }
            }
            @keyframes fadeUp {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            .anim-item {
                animation: fadeUp 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
                opacity: 0;
            }
            @keyframes spin {
                from {
                    transform: rotate(0deg);
                }
                to {
                    transform: rotate(360deg);
                }
            }
            .spin-anim {
                animation: spin 1s linear infinite;
                opacity: 1;
            }
        </style>
    </head>
    <body>
        <div id="app">
            <div id="emulator-overlay" v-show="showEmulator">
                <div class="emu-top-bar">
                    <div class="emu-btn danger" @click="closeEmulator">
                        <i class="ri-close-circle-line" style="font-size: 18px"></i> 退出游戏
                    </div>
                </div>

                <div id="game"></div>

                <div class="emu-bottom-spacer"></div>
            </div>

            <div class="navbar">
                <div class="nav-btn" v-if="currentSystemObj" @click="handleUiBack">
                    <i class="ri-arrow-left-line"></i>
                </div>
                <div class="nav-title">{{ currentSystemObj ? currentSystemObj.fullname : 'RetroHub' }}</div>
                <div class="nav-btn" v-if="currentSystemObj" style="opacity: 0; pointer-events: none">
                    <i class="ri-search-2-line"></i>
                </div>
            </div>

            <transition :name="transitionName">
                <div class="page-container" v-if="!currentSystemObj" key="home" @scroll="handleScroll">
                    <van-index-bar
                        :index-list="systemIndexList"
                        :sticky="false"
                        highlight-color="var(--primary)"
                        @select="onIndexSelect"
                        ref="systemIndexBarRef"
                    >
                        <div v-for="(group, letter) in groupedSystems" :key="letter">
                            <van-index-anchor :index="letter">{{ letter }}</van-index-anchor>
                            <div class="sys-group">
                                <div
                                    v-for="sys in group"
                                    :key="sys.name"
                                    class="sys-card anim-item"
                                    @click="enterSystem(sys)"
                                >
                                    <div class="sys-visual" :style="{ background: getSysColor(sys.name) }">
                                        <div
                                            class="sys-abbr"
                                            :style="{ fontSize: (sys.abbr && sys.abbr.length > 5) ? '26px' : '28px' }"
                                        >
                                            {{ sys.abbr }}
                                        </div>
                                        <div class="sys-count-badge">{{ sys.count }}</div>
                                    </div>
                                    <div class="sys-content">
                                        <div class="sys-header"><div class="sys-name">{{ sys.fullname }}</div></div>
                                        <div class="sys-meta" v-if="sys.year">{{ sys.maker }} • {{ sys.year }}</div>
                                        <div class="sys-desc">{{ sys.desc }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </van-index-bar>
                    <van-empty v-if="systems.length===0" description="Library Empty" image="search" />
                </div>

                <div v-else class="page-container" key="gamelist" ref="gameListContainerRef" @scroll="handleGameScroll">
                    <div class="intro-header" :style="{ background: getSysColor(currentSystemObj.name) }">
                        <i class="ri-gamepad-fill intro-bg-icon"></i>
                        <div class="intro-title">{{ currentSystemObj.fullname }}</div>
                        <div class="intro-text">{{ currentSystemObj.history }}</div>
                    </div>

                    <div style="display: flex; align-items: center; margin-bottom: 10px; gap: 10px">
                        <van-search
                            v-model="keyword"
                            placeholder="Find your memory..."
                            shape="round"
                            background="transparent"
                            :clearable="false"
                            style="flex: 1; padding: 0"
                            @search="onSearch"
                            ref="searchRef"
                        >
                            <template #right-icon>
                                <div v-show="keyword" class="custom-clear-btn" @click.stop="onClearSearch">
                                    <i class="ri-close-circle-fill"></i>
                                </div>
                            </template>
                        </van-search>

                        <div
                            @click="triggerSync"
                            style="
                                background: rgba(255, 255, 255, 0.1);
                                padding: 8px;
                                border-radius: 50%;
                                cursor: pointer;
                                display: flex;
                            "
                        >
                            <i
                                v-if="globalStatus.runningSystem === currentSystemObj.name"
                                class="ri-loader-4-line spin-anim"
                                style="color: var(--primary); font-size: 20px"
                            ></i>
                            <i
                                v-else-if="globalStatus.pendingQueue.includes(currentSystemObj.name)"
                                class="ri-hourglass-line"
                                style="color: #aaa; font-size: 20px"
                            ></i>
                            <i v-else class="ri-refresh-line" style="color: var(--primary); font-size: 20px"></i>
                        </div>
                    </div>

                    <van-loading v-if="loading" vertical style="padding: 100px 0; color: #666"
                        >Loading Index...</van-loading
                    >

                    <van-empty v-if="!loading && allGames.length === 0" description="暂无数据">
                        <template #image
                            ><i class="ri-gamepad-line" style="font-size: 90px; color: rgba(255, 255, 255, 0.15)"></i
                        ></template>
                    </van-empty>

                    <div v-else class="virtual-wrapper" :style="{ height: totalVirtualHeight + 'px' }">
                        <div
                            v-for="row in visibleVirtualRows"
                            :key="row.id"
                            class="virtual-row"
                            :class="{ 'virtual-anchor-row': row.type === 'header' }"
                            :style="{ 
                                top: row.top + 'px', 
                                height: row.height + 'px',
                                gridTemplateColumns: row.type === 'grid' ? `repeat(${virtualColCount}, 1fr)` : 'none'
                            }"
                        >
                            <template v-if="row.type === 'header'">{{ row.text }}</template>
                            <template v-else-if="row.type === 'grid'">
                                <div
                                    v-for="game in row.items"
                                    :key="game.name"
                                    class="game-card"
                                    @click="openDetail(game)"
                                >
                                    <div class="thumb-box">
                                        <div v-if="!getGamePoster(game)" class="no-img">
                                            <i class="ri-gamepad-line" style="font-size: 32px"></i>
                                        </div>
                                        <template v-else>
                                            <img class="thumb-bg lazy-img" v-lazy="getGamePoster(game)" />
                                            <img class="thumb-img lazy-img" v-lazy="getGamePoster(game)" />
                                        </template>
                                        <div class="ver-badge" v-if="game.version_count > 1">
                                            {{ game.version_count }} Ver
                                        </div>
                                        <div class="game-info-overlay">
                                            <div class="g-rating" v-if="game.rating && game.rating > 0">
                                                <van-rate
                                                    :model-value="Number(game.rating) * 5"
                                                    readonly
                                                    allow-half
                                                    size="10px"
                                                    gutter="2px"
                                                    color="#705df2"
                                                    void-icon="star"
                                                    void-color="#555"
                                                />
                                            </div>
                                            <div class="g-year">
                                                {{ game.releasedate ? game.releasedate.substring(0,4) : '' }}
                                            </div>
                                            <div class="g-title">{{ game.name }}</div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                    <div style="height: 40px"></div>
                </div>
            </transition>

            <div
                class="index-hint"
                v-show="!showDetail && !showLogPopup"
                :class="{ 'active-scroll': isScrollingPage || isTouchingIndex }"
                :style="{ top: indicatorTop + 'px' }"
            ></div>

            <div
                class="side-bubble"
                :class="{ visible: showLetterToast && !showLogPopup }"
                :style="{ top: bubbleY + 'px' }"
            >
                <span>{{ currentLetter }}</span>
            </div>

            <div
                v-if="(!loading && (currentSystemObj ? virtualIndexList.length > 0 : systemIndexList.length > 0))"
                class="custom-sidebar"
                ref="customSidebarRef"
                :style="{ top: sidebarTop + 'px' }"
            >
                <div
                    v-for="char in (currentSystemObj ? virtualIndexList : systemIndexList)"
                    :key="char"
                    class="custom-index-char"
                    :class="{ active: currentLetter === char && isTouchingIndex }"
                >
                    {{ char }}
                </div>
            </div>

            <van-popup
                :show="showDetail"
                @update:show="handlePopupClose"
                position="bottom"
                round
                class="detail-popup"
                :style="{ height: '100%' }"
            >
                <div v-if="selectedGame" class="detail-flex-wrapper">
                    <div class="detail-top-bar">
                        <div class="detail-close-btn" @click="closeDetail">
                            <i class="ri-close-fill" style="font-size: 18px; color: rgba(255, 255, 255, 0.3)"></i>
                        </div>
                    </div>
                    <div class="detail-scroll-container">
                        <div class="swipe-area">
                            <van-swipe
                                ref="imgSwipe"
                                :autoplay="0"
                                indicator-color="white"
                                style="height: 100%"
                                @change="onSwipeChange"
                            >
                                <template v-if="displayMedia.length > 0">
                                    <van-swipe-item v-for="(media, idx) in displayMedia" :key="idx">
                                        <div class="swipe-inner">
                                            <div
                                                v-if="media.type === 'video'"
                                                style="
                                                    width: 100%;
                                                    height: 100%;
                                                    background: #000;
                                                    display: flex;
                                                    align-items: center;
                                                    justify-content: center;
                                                "
                                            >
                                                <video
                                                    ref="swipeVideoRef"
                                                    :src="getImgUrl(media.url)"
                                                    controls
                                                    playsinline
                                                    loop
                                                    style="max-width: 100%; max-height: 100%"
                                                    @click.stop
                                                ></video>
                                            </div>
                                            <template v-else>
                                                <img class="swipe-bg lazy-img" v-lazy="getImgUrl(media.url)" />
                                                <div class="crt-lines" v-if="lowResFlags[media.url]"></div>
                                                <img
                                                    class="swipe-img lazy-img"
                                                    :class="{ pixelated: lowResFlags[media.url], loaded: loadedFlags[media.url] }"
                                                    v-lazy="getImgUrl(media.url)"
                                                    @load="onImgLoad($event, media)"
                                                    @click="previewBig(idx)"
                                                />
                                            </template>
                                        </div>
                                    </van-swipe-item>
                                </template>
                                <van-swipe-item v-else
                                    ><div
                                        class="swipe-inner"
                                        style="background: #111; color: #555; flex-direction: column"
                                    >
                                        <i class="ri-image-line" style="font-size: 50px"></i><span>No Preview</span>
                                    </div></van-swipe-item
                                >
                            </van-swipe>
                        </div>
                        <div class="thumb-strip" v-if="displayMedia.length > 1">
                            <div
                                v-for="(media, idx) in displayMedia"
                                :key="idx"
                                class="ts-item"
                                :class="{ active: currentSwipeIndex === idx }"
                                @click="swipeTo(idx)"
                            >
                                <template v-if="media.type === 'video'">
                                    <img
                                        class="ts-img"
                                        :src="getImgUrl(selectedGame.image_path) || ''"
                                        style="opacity: 0.5"
                                    /><i class="ri-play-circle-line ts-video-icon"></i>
                                </template>
                                <img v-else class="ts-img lazy-img" v-lazy="getImgUrl(media.url)" />
                            </div>
                        </div>
                        <div class="d-body">
                            <div v-if="marqueeUrl" class="d-marquee-box">
                                <img v-lazy="getImgUrl(marqueeUrl)" class="d-marquee-bg lazy-img" />
                                <img v-lazy="getImgUrl(marqueeUrl)" class="d-marquee-img lazy-img" />
                            </div>
                            <div class="d-title">{{ selectedGame.name }}</div>
                            <div class="d-tags">
                                <span class="tag" v-if="selectedGame.rating > 0" style="color: #ffd21e"
                                    ><i class="ri-star-fill"></i> {{ (Number(selectedGame.rating) * 5).toFixed(1)
                                    }}</span
                                >
                                <span class="tag" v-if="selectedGame.releasedate"
                                    >{{ selectedGame.releasedate.substring(0,4) }}</span
                                >
                                <span class="tag" v-if="selectedGame.genre">{{ selectedGame.genre }}</span>
                                <span class="tag" v-if="selectedGame.players"
                                    ><i class="ri-user-3-fill"></i> {{ selectedGame.players }}</span
                                >
                                <span class="tag" v-if="selectedGame.publisher">{{ selectedGame.publisher }}</span>
                                <span class="tag" v-if="selectedGame.developer">{{ selectedGame.developer }}</span>
                            </div>
                            <div class="d-desc">{{ selectedGame.desc || '暂无描述信息。' }}</div>
                            <van-divider content-position="left" style="border-color: rgba(255, 255, 255, 0.1)"
                                >Available Files ({{ versions.length }})</van-divider
                            >
                            <div
                                class="ver-item"
                                v-for="ver in versions"
                                :key="ver.id"
                                :class="{ selected: currentVersionId === ver.id }"
                                @click="switchVersion(ver)"
                            >
                                <div class="v-file">{{ ver.filename }}</div>
                                <div class="ver-btn-group">
                                    <button v-if="canPlay()" class="play-btn" @click.stop="startGame(ver)">
                                        <i class="ri-gamepad-fill"></i> PLAY
                                    </button>
                                    <button class="dl-btn" @click.stop="download(ver.id)">
                                        <i class="ri-download-cloud-2-line"></i> GET
                                    </button>
                                </div>
                            </div>
                            <div style="height: 40px"></div>
                        </div>
                    </div>
                </div>
            </van-popup>

            <van-dialog
                v-model:show="showSyncDialog"
                title="选择同步内容"
                show-cancel-button
                confirm-button-text="开始同步"
                confirm-button-color="#705df2"
                @confirm="startSync"
            >
                <div style="padding: 20px 24px; display: flex; flex-direction: column; gap: 12px">
                    <van-checkbox v-model="syncOps.syncInfo" shape="square" checked-color="#705df2"
                        >游戏信息 (Info)</van-checkbox
                    >
                    <van-checkbox v-model="syncOps.syncImages" shape="square" checked-color="#705df2"
                        >游戏图片 (封面/截图)</van-checkbox
                    >
                    <van-checkbox v-model="syncOps.syncMarquees" shape="square" checked-color="#705df2"
                        >Marquees (Logo)</van-checkbox
                    >
                    <van-checkbox v-model="syncOps.syncVideo" shape="square" checked-color="#705df2"
                        >游戏视频 (Video)</van-checkbox
                    >
                </div>
            </van-dialog>

            <van-popup
                :show="showLogPopup"
                @click-overlay="handleLogClose"
                position="bottom"
                round
                class="log-popup"
                :style="{ height: '60%' }"
            >
                <div class="log-header">
                    <div style="font-weight: bold; color: #fff; font-size: 14px">
                        Running Logs
                        <span v-if="globalStatus.runningSystem" style="color: #705df2; margin-left: 5px"
                            >({{ progress.current }}/{{ progress.total }})</span
                        >
                    </div>
                    <van-button
                        size="small"
                        type="danger"
                        icon="stop-circle-line"
                        :disabled="!globalStatus.runningSystem"
                        @click="stopSync"
                        style="height: 28px; padding: 0 12px"
                        >全部中止</van-button
                    >
                </div>
                <div class="log-content">
                    <div v-if="logs.length === 0" style="text-align: center; padding: 20px; color: #666">
                        No logs available.
                    </div>
                    <div v-for="(log, i) in logs" :key="i" class="log-item">{{ log }}</div>
                </div>
            </van-popup>
        </div>

        <script src="https://fastly.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
        <script src="https://fastly.jsdelivr.net/npm/vant@4/lib/vant.min.js"></script>

        <script>
            const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;

            const useLazyObserver = () => {
                let observer = null;
                const elementStateMap = new WeakMap();
                const initObserver = () => {
                    if (observer) return;
                    observer = new IntersectionObserver(
                        (entries) => {
                            entries.forEach((entry) => {
                                const el = entry.target;
                                const state = elementStateMap.get(el);
                                if (entry.isIntersecting) {
                                    if (!state.loaded && !state.timer) {
                                        state.timer = setTimeout(() => {
                                            loadImage(el, state.src);
                                            state.loaded = true;
                                            observer.unobserve(el);
                                        }, 100);
                                    }
                                } else {
                                    if (state.timer) {
                                        clearTimeout(state.timer);
                                        state.timer = null;
                                    }
                                }
                            });
                        },
                        { rootMargin: '300px 0px' }
                    );
                };
                const loadImage = (el, src) => {
                    const img = new Image();
                    img.src = src;
                    img.decode()
                        .then(() => {
                            el.src = src;
                            el.classList.add('loaded');
                        })
                        .catch(() => {
                            el.src = src;
                            el.onload = () => el.classList.add('loaded');
                        });
                };
                return {
                    observe: (el, src) => {
                        initObserver();
                        if (!src) return;
                        elementStateMap.set(el, { src, loaded: false, timer: null });
                        observer.observe(el);
                    },
                    unobserve: (el) => {
                        if (observer) observer.unobserve(el);
                    }
                };
            };
            const lazyManager = useLazyObserver();
            const vLazy = {
                mounted: (el, binding) => {
                    lazyManager.observe(el, binding.value);
                },
                updated: (el, binding) => {
                    if (binding.value !== binding.oldValue) {
                        el.classList.remove('loaded');
                        lazyManager.observe(el, binding.value);
                    }
                },
                unmounted: (el) => {
                    lazyManager.unobserve(el);
                }
            };

            const app = createApp({
                directives: { lazy: vLazy },
                setup() {
                    const systems = ref([]);
                    const currentSystemObj = ref(null);
                    const allGames = ref([]);
                    const loading = ref(false);
                    const showSearch = ref(false);
                    const keyword = ref('');
                    const showDetail = ref(false);
                    const selectedGame = ref(null);
                    const versions = ref([]);
                    const currentVersionId = ref(null);
                    const currentSwipeIndex = ref(0);
                    const imgSwipe = ref(null);
                    const isPreviewOpen = ref(false);
                    let imagePreviewInstance = null;
                    const globalStatus = ref({
                        runningSystem: null,
                        pendingQueue: [],
                        logs: [],
                        progress: { current: 0, total: 0 }
                    });
                    const isSyncing = ref(false);
                    const showLogPopup = ref(false);
                    const logs = ref([]);
                    const progress = ref({ current: 0, total: 0 });
                    const showSyncDialog = ref(false);
                    const syncOps = ref({ syncInfo: true, syncImages: true, syncVideo: true, syncMarquees: true });
                    const showLetterToast = ref(false);
                    const currentLetter = ref('');
                    const bubbleY = ref(0);
                    const isTouchingIndex = ref(false);
                    const isScrollingPage = ref(false);
                    let scrollTimeout = null;
                    const systemIndexBarRef = ref(null);
                    const gameListContainerRef = ref(null);
                    const customSidebarRef = ref(null);
                    const swipeVideoRef = ref(null);
                    const indicatorTop = ref(70);
                    const sidebarTop = ref(70);
                    let sidebarRectCache = null;
                    let animationFrameId = null;
                    let statusPollTimer = null;
                    const transitionName = ref('slide-left');
                    const lowResFlags = ref({});
                    const loadedFlags = ref({});
                    const searchRef = ref(null);

                    const virtualRows = ref([]);
                    const visibleVirtualRows = ref([]);
                    const totalVirtualHeight = ref(0);
                    const virtualColCount = ref(3);
                    const virtualMap = ref({});
                    const virtualIndexList = ref([]);
                    const lastScrollTop = ref(0);

                    const showEmulator = ref(false);

                    watch(keyword, (newVal) => {
                        if (newVal === '' && currentSystemObj.value) {
                            onClearSearch();
                        }
                    });

                    const fetchSystems = async () => {
                        try {
                            const res = await fetch('/api/systems');
                            systems.value = await res.json();
                            nextTick(() => updateLayoutFromScroll(0, document.body.clientHeight - 80));
                        } catch (e) {
                            console.error(e);
                        }
                    };

                    const pollStatus = async () => {
                        try {
                            const res = await fetch('/api/status/global');
                            const data = await res.json();
                            globalStatus.value = data;
                            logs.value = data.logs.reverse();
                            progress.value = data.progress;
                            isSyncing.value = !!data.runningSystem;

                            if (isSyncing.value || showLogPopup.value) {
                                if (statusPollTimer) clearTimeout(statusPollTimer);
                                statusPollTimer = setTimeout(pollStatus, 1500);
                            }
                        } catch (e) {
                            console.error('Network error, retrying...', e);
                            if (isSyncing.value || showLogPopup.value) {
                                if (statusPollTimer) clearTimeout(statusPollTimer);
                                statusPollTimer = setTimeout(pollStatus, 3000);
                            }
                        }
                    };

                    const loadGames = async (sysObj) => {
                        loading.value = true;
                        allGames.value = [];
                        virtualRows.value = [];
                        visibleVirtualRows.value = [];
                        try {
                            const k = keyword.value ? encodeURIComponent(keyword.value) : '';
                            const res = await fetch(`/api/games?system=${sysObj.name}&all=1&keyword=${k}`);
                            const data = await res.json();
                            allGames.value = data.data;
                            calculateVirtualLayout();
                        } finally {
                            loading.value = false;
                            nextTick(() => {
                                if (gameListContainerRef.value) gameListContainerRef.value.scrollTop = 0;
                                updateVisibleRows(0);
                                updateLayoutFromScroll(0, window.innerHeight);
                            });
                        }
                    };

                    const calculateVirtualLayout = () => {
                        if (!allGames.value.length) return;
                        const containerWidth = window.innerWidth - 32;
                        const itemMinWidth = 105;
                        const gap = 16;
                        const cols = Math.floor((containerWidth + gap) / (itemMinWidth + gap));
                        virtualColCount.value = cols;
                        const realItemWidth = (containerWidth - (cols - 1) * gap) / cols;
                        const itemHeight = realItemWidth * (4 / 3);
                        const headerHeight = 44;
                        const rowHeight = itemHeight + 20;

                        const groups = {};
                        allGames.value.forEach((game) => {
                            let letter = (game.name || '#')[0].toUpperCase();
                            if (!/[A-Z]/.test(letter)) letter = '#';
                            if (!groups[letter]) groups[letter] = [];
                            groups[letter].push(game);
                        });
                        const sortedKeys = Object.keys(groups).sort();
                        virtualIndexList.value = sortedKeys;

                        let currentTop = 0;
                        const rows = [];
                        const map = {};

                        sortedKeys.forEach((letter) => {
                            map[letter] = currentTop;
                            rows.push({
                                id: `h-${letter}`,
                                type: 'header',
                                text: letter,
                                top: currentTop,
                                height: headerHeight
                            });
                            currentTop += headerHeight;
                            const games = groups[letter];
                            for (let i = 0; i < games.length; i += cols) {
                                const chunk = games.slice(i, i + cols);
                                rows.push({
                                    id: `g-${letter}-${i}`,
                                    type: 'grid',
                                    items: chunk,
                                    top: currentTop,
                                    height: rowHeight
                                });
                                currentTop += rowHeight;
                            }
                        });
                        virtualRows.value = rows;
                        virtualMap.value = map;
                        totalVirtualHeight.value = currentTop;
                    };

                    const updateVisibleRows = (scrollTop) => {
                        const viewportHeight = window.innerHeight;
                        const buffer = 300;
                        const startY = scrollTop - buffer;
                        const endY = scrollTop + viewportHeight + buffer;
                        visibleVirtualRows.value = virtualRows.value.filter((row) => {
                            const rowBottom = row.top + row.height;
                            return rowBottom > startY && row.top < endY;
                        });
                    };

                    const handleGameScroll = (e) => {
                        const scrollTop = e.target.scrollTop;
                        if (document.activeElement && document.activeElement.tagName === 'INPUT') {
                            document.activeElement.blur();
                        }
                        lastScrollTop.value = scrollTop;
                        handleScroll(e);
                        if (animationFrameId) cancelAnimationFrame(animationFrameId);
                        animationFrameId = requestAnimationFrame(() => {
                            updateVisibleRows(scrollTop);
                        });
                    };

                    const jumpToLetter = (char) => {
                        const targetTop = virtualMap.value[char];
                        if (targetTop !== undefined && gameListContainerRef.value) {
                            const wrapper = document.querySelector('.virtual-wrapper');
                            const offset = wrapper ? wrapper.offsetTop : 300;
                            gameListContainerRef.value.scrollTo({ top: targetTop + offset, behavior: 'auto' });
                        }
                    };

                    const enterSystem = async (sysObj) => {
                        transitionName.value = 'slide-left';
                        window.history.pushState({ page: 'gamelist', systemName: sysObj.name }, '');
                        currentSystemObj.value = sysObj;
                        keyword.value = '';
                        indicatorTop.value = 70;
                        sidebarTop.value = 70;
                        if (globalStatus.value.runningSystem) pollStatus();
                        loadGames(sysObj);
                    };

                    const handleUiBack = () => {
                        if (currentSystemObj.value && !showDetail.value && !showLogPopup.value) {
                            if (window.history.state && window.history.state.page === 'gamelist') {
                                if (window.history.length <= 2) {
                                    transitionName.value = 'slide-right';
                                    currentSystemObj.value = null;
                                    window.history.replaceState({ page: 'home' }, '');
                                    indicatorTop.value = 70;
                                    return;
                                }
                            }
                        }
                        window.history.back();
                    };

                    const updateLayoutFromScroll = () => {
                        const safeTop = 66;
                        const safeBottomPadding = 20;
                        const indicatorHeight = 40;
                        const viewHeight = window.innerHeight;
                        const trackLength = viewHeight - safeTop - safeBottomPadding - indicatorHeight;

                        const container = currentSystemObj.value
                            ? gameListContainerRef.value
                            : document.querySelector('.page-container');
                        if (!container) return;

                        const scrollRange = container.scrollHeight - container.clientHeight;
                        const ratio = scrollRange > 0 ? container.scrollTop / scrollRange : 0;

                        const currentIndTop = safeTop + ratio * trackLength;
                        indicatorTop.value = currentIndTop;

                        const sidebar = customSidebarRef.value || document.querySelector('.custom-sidebar');

                        if (sidebar) {
                            const sbHeight = sidebar.offsetHeight || 0;
                            let targetSidebarTop = currentIndTop + indicatorHeight / 2 - sbHeight / 2;
                            const minTop = safeTop;
                            const maxTop = viewHeight - sbHeight - safeBottomPadding;

                            targetSidebarTop = Math.max(minTop, Math.min(targetSidebarTop, maxTop));
                            sidebarTop.value = targetSidebarTop;
                        }
                    };

                    const handleScroll = (e) => {
                        isScrollingPage.value = true;
                        if (scrollTimeout) clearTimeout(scrollTimeout);
                        scrollTimeout = setTimeout(() => {
                            isScrollingPage.value = false;
                        }, 1000);
                        if (!isTouchingIndex.value) {
                            updateLayoutFromScroll();
                        }
                    };

                    const handleIndexTouch = (e) => {
                        const isHint =
                            e.target.closest('.index-hint') ||
                            e.target.closest('.van-index-bar__sidebar') ||
                            e.target.closest('.custom-sidebar');

                        if (isHint) {
                            e.preventDefault();
                        }

                        if (e.type === 'touchstart') {
                            if (!isHint) return;

                            isTouchingIndex.value = true;
                            document.body.classList.add('touching-sidebar');

                            const sidebar = customSidebarRef.value || document.querySelector('.custom-sidebar');

                            const list = currentSystemObj.value ? virtualIndexList.value : systemIndexList.value;

                            if (sidebar) {
                                const rect = sidebar.getBoundingClientRect();
                                sidebarRectCache = {
                                    top: rect.top,
                                    height: rect.height,
                                    itemHeight: rect.height / list.length,
                                    list: list,
                                    isGame: !!currentSystemObj.value
                                };
                            }
                            calcCurrentLetter(e.touches[0]);
                        }

                        if (isTouchingIndex.value) {
                            if (e.type === 'touchmove') {
                                calcCurrentLetter(e.touches[0]);
                            } else if (e.type === 'touchend' || e.type === 'touchcancel') {
                                isTouchingIndex.value = false;
                                document.body.classList.remove('touching-sidebar');
                                setTimeout(() => (showLetterToast.value = false), 300);

                                if (currentLetter.value) {
                                    if (sidebarRectCache && sidebarRectCache.isGame) {
                                        jumpToLetter(currentLetter.value);
                                    } else {
                                        if (systemIndexBarRef.value)
                                            systemIndexBarRef.value.scrollTo(currentLetter.value);
                                    }
                                }
                                updateLayoutFromScroll();
                            }
                        }
                    };

                    const safeVibrate = () => {
                        if (!navigator.vibrate) return;
                        if (navigator.userActivation && !navigator.userActivation.hasBeenActive) {
                            return;
                        }
                        try {
                            navigator.vibrate(15);
                        } catch (e) {}
                    };

                    const calcCurrentLetter = (touch) => {
                        if (!sidebarRectCache || sidebarRectCache.list.length === 0) return;

                        const relativeY = touch.clientY - sidebarRectCache.top;
                        let index = Math.floor(relativeY / sidebarRectCache.itemHeight);
                        index = Math.max(0, Math.min(index, sidebarRectCache.list.length - 1));
                        const char = sidebarRectCache.list[index];

                        if (char && char !== currentLetter.value) {
                            currentLetter.value = char;
                            showLetterToast.value = true;
                            safeVibrate();
                        } else if (char) {
                            showLetterToast.value = true;
                        }

                        const minY = sidebarRectCache.top;
                        const maxY = sidebarRectCache.top + sidebarRectCache.height;
                        bubbleY.value = Math.max(minY, Math.min(touch.clientY, maxY));
                    };

                    const onIndexSelect = (index) => {};

                    window.addEventListener('popstate', (event) => {
                        const state = event.state;
                        if (isPreviewOpen.value) {
                            isPreviewOpen.value = false;
                            if (imagePreviewInstance) {
                                imagePreviewInstance.close();
                                imagePreviewInstance = null;
                            }
                            return;
                        }
                        const targetPage = state && state.page ? state.page : 'home';
                        if (targetPage === 'gamelist') {
                            showLogPopup.value = false;
                            showDetail.value = false;
                            pauseAllVideos();
                            if (!currentSystemObj.value && state.systemName) {
                                transitionName.value = 'slide-left';
                                const sys = systems.value.find((s) => s.name === state.systemName);
                                if (sys) {
                                    currentSystemObj.value = sys;
                                    loadGames(sys);
                                    pollStatus();
                                }
                            }
                        } else if (targetPage === 'home') {
                            showLogPopup.value = false;
                            showDetail.value = false;
                            pauseAllVideos();
                            transitionName.value = 'slide-right';
                            currentSystemObj.value = null;
                            showSearch.value = false;
                            allGames.value = [];
                            indicatorTop.value = 70;
                        } else if (targetPage === 'detail') {
                            showDetail.value = true;
                            showLogPopup.value = false;
                        } else if (targetPage === 'log') {
                            showLogPopup.value = true;
                        }
                    });

                    onMounted(() => {
                        fetchSystems();
                        pollStatus();
                        window.history.replaceState({ page: 'home' }, '');

                        window.addEventListener('touchstart', handleIndexTouch, { passive: false });
                        window.addEventListener('touchmove', handleIndexTouch, { passive: false });
                        window.addEventListener('touchend', handleIndexTouch);
                        window.addEventListener('resize', () => {
                            if (currentSystemObj.value) {
                                calculateVirtualLayout();
                                updateVisibleRows(lastScrollTop.value);
                            }
                        });
                        setTimeout(() => updateLayoutFromScroll(), 500);
                    });

                    const pauseAllVideos = () => {
                        if (swipeVideoRef.value) {
                            const videos = Array.isArray(swipeVideoRef.value)
                                ? swipeVideoRef.value
                                : [swipeVideoRef.value];
                            videos.forEach((v) => v && v.pause && v.pause());
                        }
                    };

                    const openDetail = async (game) => {
                        window.history.pushState(
                            { page: 'detail', systemName: currentSystemObj.value.name, gameName: game.name },
                            ''
                        );
                        selectedGame.value = game;
                        currentSwipeIndex.value = 0;
                        showDetail.value = true;
                        nextTick(() => {
                            const detailContainer = document.querySelector('.detail-scroll-container');
                            if (detailContainer) detailContainer.scrollTop = 0;
                        });
                        versions.value = [];
                        currentVersionId.value = null;
                        const res = await fetch(
                            `/api/game-versions?system=${currentSystemObj.value.name}&name=${encodeURIComponent(game.name)}`
                        );
                        versions.value = await res.json();
                        if (versions.value.length > 0) currentVersionId.value = versions.value[0].id;
                        nextTick(() => {
                            if (imgSwipe.value) imgSwipe.value.swipeTo(0, { immediate: true });
                            checkAutoPlay(0);
                        });
                    };

                    const closeDetail = () => {
                        window.history.back();
                    };
                    const viewLogs = () => {
                        window.history.pushState({ page: 'log' }, '');
                        showLogPopup.value = true;
                        pollStatus();
                    };
                    const triggerSync = async () => {
                        if (showLogPopup.value) return;
                        const currentSysName = currentSystemObj.value.name;
                        const isRunning = globalStatus.value.runningSystem === currentSysName;
                        const isQueued = globalStatus.value.pendingQueue.includes(currentSysName);
                        if (isRunning || isQueued) {
                            viewLogs();
                        } else {
                            showSyncDialog.value = true;
                        }
                    };
                    const startSync = async () => {
                        const sysName = currentSystemObj.value.name;
                        if (globalStatus.value.runningSystem) {
                            if (!globalStatus.value.pendingQueue.includes(sysName)) {
                                globalStatus.value.pendingQueue.push(sysName);
                            }
                        } else {
                            globalStatus.value.runningSystem = sysName;
                        }
                        await fetch(`/api/scan/${sysName}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(syncOps.value)
                        });
                        vant.showToast({ message: '请求已提交', icon: 'success' });
                        pollStatus();
                        viewLogs();
                    };
                    const stopSync = async () => {
                        try {
                            await fetch(`/api/stop-scan`, { method: 'POST' });
                            vant.showToast('已清空队列并中止');
                        } catch (e) {
                            console.error(e);
                        }
                    };
                    const handlePopupClose = (val) => {
                        if (val === false) window.history.back();
                    };
                    const handleLogClose = () => window.history.back();
                    const switchVersion = (ver) => {
                        currentVersionId.value = ver.id;
                        if (imgSwipe.value) imgSwipe.value.swipeTo(0);
                    };
                    const swipeTo = (idx) => {
                        if (imgSwipe.value) imgSwipe.value.swipeTo(idx);
                    };
                    const onSwipeChange = (idx) => {
                        currentSwipeIndex.value = idx;
                        checkAutoPlay(idx);
                    };
                    const checkAutoPlay = (idx) => {
                        const media = displayMedia.value[idx];
                        pauseAllVideos();
                        if (media && media.type === 'video') {
                            nextTick(() => {
                                if (swipeVideoRef.value) {
                                    const videos = Array.isArray(swipeVideoRef.value)
                                        ? swipeVideoRef.value
                                        : [swipeVideoRef.value];
                                    videos.forEach((v) => {
                                        if (v && v.play) v.play().catch((e) => {});
                                    });
                                }
                            });
                        }
                    };
                    const previewBig = (idx) => {
                        const imagesOnly = displayMedia.value.filter((m) => m.type !== 'video');
                        if (imagesOnly.length === 0) return;
                        const currentMedia = displayMedia.value[idx];
                        if (currentMedia.type === 'video') return;
                        const imgIndex = imagesOnly.indexOf(currentMedia);
                        if (imgIndex === -1) return;
                        window.history.pushState({ page: 'preview' }, '');
                        isPreviewOpen.value = true;
                        pauseAllVideos();
                        imagePreviewInstance = vant.showImagePreview({
                            images: imagesOnly.map((i) => getImgUrl(i.url)),
                            startPosition: imgIndex,
                            closeable: true,
                            onClose: () => {
                                if (isPreviewOpen.value) window.history.back();
                                imagePreviewInstance = null;
                            }
                        });
                    };
                    const getSysColor = (sysName) => {
                        const colors = [
                            'linear-gradient(135deg, #ff5e57, #d63031)',
                            'linear-gradient(135deg, #a29bfe, #6c5ce7)',
                            'linear-gradient(135deg, #00b894, #00cec9)',
                            'linear-gradient(135deg, #fdcb6e, #e17055)',
                            'linear-gradient(135deg, #74b9ff, #0984e3)',
                            'linear-gradient(135deg, #636e72, #2d3436)'
                        ];
                        let hash = 0;
                        for (let i = 0; i < sysName.length; i++) hash = sysName.charCodeAt(i) + ((hash << 5) - hash);
                        return colors[Math.abs(hash) % colors.length];
                    };
                    const getImgUrl = (path) =>
                        path
                            ? '/' +
                              path
                                  .split('/')
                                  .map((p) => encodeURIComponent(p))
                                  .join('/')
                            : '';
                    const onImgLoad = (e, media) => {
                        e.target.classList.add('loaded');
                        loadedFlags.value[media.url] = true;
                        const isCover = media.type === 'covers' || media.type === 'Cover' || media.type === 'titles';
                        if (!isCover && e.target.naturalHeight && e.target.naturalHeight < 720) {
                            lowResFlags.value[media.url] = true;
                        }
                    };
                    const download = (id) => (window.location.href = `/api/download/${id}`);
                    const getGamePoster = (game) => {
                        const url = game.image_path || game.marquee_path || game.video_path;
                        return getImgUrl(url);
                    };

                    const canPlay = () => {
                        if (!currentSystemObj.value) return false;
                        return !!currentSystemObj.value.core;
                    };

                    // 【文件名修正版】startGame
                    const startGame = (ver) => {
                        const coreName = currentSystemObj.value.core;
                        if (!coreName) {
                            vant.showToast('该主机暂不支持在线游玩 (No Core Defined)');
                            return;
                        }

                        showEmulator.value = true;
                        pauseAllVideos();

                        const container = document.getElementById('game');
                        container.innerHTML = '';
                        const iframe = document.createElement('iframe');
                        iframe.style.width = '100%';
                        iframe.style.height = '100%';
                        iframe.style.border = 'none';
                        iframe.id = 'emulator-iframe';

                        const safeName = selectedGame.value.name.replace(/'/g, "\\'").replace(/"/g, '\\"');
                        const biosFilename = currentSystemObj.value.bios;
                        const biosUrl = biosFilename ? `${window.location.origin}/bios/${biosFilename}` : '';

                        // 【关键修改】在 URL 后面拼接真实文件名
                        // 例如: /api/play-merged/123/kof97.zip
                        // 这样 EmulatorJS 保存文件时就是 kof97.zip，FBNeo 就能认出来了
                        const safeFilename = encodeURIComponent(ver.filename);
                        const gameUrl = `${window.location.origin}/api/play-merged/${ver.id}/${safeFilename}`;

                        const htmlContent = `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <style>
                                body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #000; overflow: hidden; }
                                #emulator { width: 100%; height: 100%; }
                            </style>
                        </head>
                        <body>
                            <div id="emulator"></div>
                            <script>
                                window.EJS_player = '#emulator';
                                window.EJS_core = '${coreName}';
                                window.EJS_gameName = '${safeName}';
                                window.EJS_biosUrl = '${biosUrl}';
                                window.EJS_gameUrl = '${gameUrl}';
                                window.EJS_pathtodata = 'data/';
                                window.EJS_startOnLoaded = true;
                                
                                window.EJS_defaultOptions = {
                                    'save-state-location': 'browser',
                                    'save-sram-location': 'browser'
                                };
                            <\/script>
                            <script src="data/loader.js"><\/script>
                        </body>
                        </html>
                        `;

                        container.appendChild(iframe);
                        const doc = iframe.contentWindow.document;
                        doc.open();
                        doc.write(htmlContent);
                        doc.close();
                    };

                    const closeEmulator = () => {
                        showEmulator.value = false;
                        const container = document.getElementById('game');
                        if (container) {
                            // 直接移除 iframe，这是唯一能彻底杀死 WASM 进程和音频的方法
                            container.innerHTML = '';
                        }
                        window.EJS_player = null;
                    };

                    const groupedSystems = computed(() => {
                        if (!systems.value.length) return {};
                        const groups = {};
                        systems.value.forEach((sys) => {
                            const makerName = sys.maker || 'Unknown';
                            let letter = makerName[0].toUpperCase();
                            if (!/[A-Z]/.test(letter)) letter = '#';
                            if (!groups[letter]) groups[letter] = [];
                            groups[letter].push(sys);
                        });
                        return Object.keys(groups)
                            .sort()
                            .reduce((obj, key) => {
                                obj[key] = groups[key];
                                return obj;
                            }, {});
                    });
                    const systemIndexList = computed(() => Object.keys(groupedSystems.value));

                    const marqueeUrl = computed(() => {
                        if (!currentVersionId.value) return '';
                        const ver = versions.value.find((v) => v.id === currentVersionId.value);
                        if (ver && ver.gallery) {
                            const m = ver.gallery.find((img) => img.type === 'marquees');
                            return m ? m.url : '';
                        }
                        return '';
                    });

                    const displayMedia = computed(() => {
                        const list = [];
                        if (selectedGame.value && selectedGame.value.video_path) {
                            list.push({ type: 'video', url: selectedGame.value.video_path });
                        }
                        if (currentVersionId.value) {
                            const ver = versions.value.find((v) => v.id === currentVersionId.value);
                            if (ver && ver.gallery && ver.gallery.length > 0) {
                                const images = ver.gallery.filter((g) => g.type !== 'marquees');
                                list.push(...images);
                            } else if (selectedGame.value.image_path) {
                                list.push({ type: 'Cover', url: selectedGame.value.image_path });
                            }
                        }
                        return list;
                    });

                    const onSearch = () => {
                        if (currentSystemObj.value) {
                            loadGames(currentSystemObj.value);
                        }
                    };
                    const onClearSearch = () => {
                        keyword.value = '';
                        onSearch();
                    };

                    return {
                        systems,
                        currentSystemObj,
                        loading,
                        showSearch,
                        keyword,
                        showDetail,
                        selectedGame,
                        versions,
                        currentVersionId,
                        displayMedia,
                        marqueeUrl,
                        currentSwipeIndex,
                        imgSwipe,
                        swipeVideoRef,
                        enterSystem,
                        handleUiBack,
                        openDetail,
                        closeDetail,
                        switchVersion,
                        swipeTo,
                        onSwipeChange,
                        previewBig,
                        getSysColor,
                        getImgUrl,
                        download,
                        onImgLoad,
                        triggerSync,
                        startSync,
                        stopSync,
                        showSyncDialog,
                        syncOps,
                        isSyncing,
                        showLogPopup,
                        logs,
                        viewLogs,
                        handlePopupClose,
                        handleLogClose,
                        onSearch,
                        onClearSearch,
                        showLetterToast,
                        currentLetter,
                        bubbleY,
                        transitionName,
                        isTouchingIndex,
                        onIndexSelect,
                        groupedSystems,
                        systemIndexList,
                        handleScroll,
                        handleGameScroll,
                        isScrollingPage,
                        systemIndexBarRef,
                        gameListContainerRef,
                        customSidebarRef,
                        indicatorTop,
                        sidebarTop,
                        progress,
                        globalStatus,
                        lowResFlags,
                        loadedFlags,
                        getGamePoster,
                        allGames,
                        visibleVirtualRows,
                        totalVirtualHeight,
                        virtualColCount,
                        virtualIndexList,
                        searchRef,
                        // Emulator Props
                        showEmulator,
                        startGame,
                        closeEmulator,
                        canPlay
                    };
                }
            });

            app.use(vant);
            app.mount('#app');
        </script>
    </body>
</html>
