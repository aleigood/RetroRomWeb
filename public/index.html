<!doctype html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
        />
        <meta name="theme-color" content="#101014" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

        <title>RetroRom Hub</title>
        <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/vant@4/lib/index.css" />
        <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet" />
        <style>
            :root {
                --bg-body: #101014;
                --bg-card: #1c1c22;
                --text-main: #f2f2f2;
                --text-sub: #8a8a9b;
                --primary: #705df2;
                --accent: #ff4757;
                --nav-height: 56px;

                /* 搜索框深色样式 */
                --van-search-content-background: rgba(255, 255, 255, 0.1) !important;
                --van-search-label-color: #fff !important;
                --van-text-color: #fff !important;
                --van-search-input-height: 36px !important;
                --van-field-input-text-color: #fff !important;
            }

            * {
                scrollbar-width: none !important;
                -ms-overflow-style: none !important;
            }
            ::-webkit-scrollbar {
                display: none !important;
                width: 0 !important;
                height: 0 !important;
            }

            html {
                height: 100%;
                overflow: hidden;
                background: var(--bg-body);
            }

            body {
                height: 100%;
                overflow: hidden;
                background: var(--bg-body);
                color: var(--text-main);
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                margin: 0;
                -webkit-tap-highlight-color: transparent;

                /* 定义 CSS 变量初始值 */
                --sidebar-top: 70px;
            }

            #app {
                height: 100%;
                width: 100%;
                position: relative;
                overflow: hidden;
            }

            /* === 基础组件样式 === */
            .navbar {
                background: rgba(28, 28, 34, 0.95);
                backdrop-filter: blur(20px);
                height: var(--nav-height);
                display: flex;
                align-items: center;
                padding: 0 16px;
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                z-index: 500;
                border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            }
            .nav-title {
                font-weight: 800;
                font-size: 18px;
                flex: 1;
                text-align: center;
                letter-spacing: 0.5px;
            }
            .nav-btn {
                font-size: 24px;
                padding: 8px;
                color: var(--text-main);
                cursor: pointer;
                transition: opacity 0.2s;
            }
            .nav-btn:active {
                opacity: 0.6;
            }

            .page-container {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                box-sizing: border-box;
                padding-top: calc(var(--nav-height) + 16px);
                padding-bottom: 40px;
                padding-left: 16px;
                padding-right: 16px;
                background: var(--bg-body);
            }

            /* === 弹窗样式修正 === */
            .van-popup.van-dialog {
                background: #25252b !important;
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 16px !important;
                overflow: hidden;
                box-shadow: 0 25px 60px -10px rgba(0, 0, 0, 0.9) !important;
            }
            .van-dialog__header {
                color: #fff !important;
                padding-top: 24px;
                font-weight: 800;
            }
            .van-dialog__message {
                color: #ccc !important;
                font-size: 14px;
                line-height: 1.6;
                padding: 24px !important;
                text-align: center;
            }
            .van-dialog__footer {
                padding: 0 !important;
                display: flex !important;
                width: 100% !important;
                gap: 0 !important;
            }
            .van-hairline--top::after,
            .van-hairline--left::after {
                border: none !important;
            }
            .van-dialog__button {
                flex: 1 !important;
                border-radius: 0 !important;
                margin: 0 !important;
                height: 48px !important;
                border: none !important;
            }
            .van-dialog__cancel {
                background: #3a3a44 !important;
                color: #fff !important;
            }
            .van-dialog__confirm {
                background: linear-gradient(135deg, #ff4757, #ff6b81) !important;
                color: white !important;
            }

            /* 搜索框样式 */
            .van-search__field .van-field__control {
                color: #fff !important;
            }
            .van-search__field .van-field__left-icon {
                color: rgba(255, 255, 255, 0.5) !important;
            }

            /* === 索引栏 & 标记 === */
            .index-hint {
                position: fixed;
                right: 4px;
                width: 4px;
                height: 40px;
                background: rgba(255, 255, 255, 0.6);
                border-radius: 4px;
                z-index: 2500;
                pointer-events: auto;
                transition: opacity 0.3s;
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
                opacity: 0.1;
                touch-action: none;
            }
            .index-hint::before {
                content: '';
                position: absolute;
                top: -10px;
                bottom: -10px;
                left: -20px;
                right: -10px;
                background: transparent;
            }

            .index-hint.active-scroll {
                opacity: 0.8;
            }

            .index-hint::after {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 2px;
                height: 16px;
                background: rgba(0, 0, 0, 0.3);
                border-radius: 2px;
            }
            body.touching-sidebar .index-hint {
                opacity: 0;
            }

            /* 动态跟随位置的索引栏 */
            .van-index-bar__sidebar {
                position: fixed !important;
                right: 0 !important;
                z-index: 2000 !important;
                width: 30px;
                background: transparent !important;
                box-shadow: none !important;
                opacity: 0;

                top: var(--sidebar-top) !important;
                bottom: auto !important;
                height: auto !important;
                transform: translateY(0) !important;

                display: flex !important;
                flex-direction: column !important;
                justify-content: center !important;

                touch-action: none;
                user-select: none;
                -webkit-user-select: none;
                transition:
                    opacity 0.2s,
                    top 0.1s linear;
                pointer-events: none !important;
            }

            .van-index-bar__index {
                padding: 2px 0 !important;
                text-align: center;
                color: rgba(255, 255, 255, 0.6) !important;
                font-size: 10px;
                font-weight: 700 !important;
                line-height: 1.4;
            }

            body.touching-sidebar .van-index-bar__sidebar {
                background: rgba(0, 0, 0, 0.7) !important;
                border-top-left-radius: 16px;
                border-bottom-left-radius: 16px;
                right: 0 !important;
                opacity: 1 !important;
                padding: 8px 0;
                pointer-events: auto !important;
            }
            body.touching-sidebar .van-index-bar__index--active {
                color: #fff !important;
                transform: scale(1.5);
            }

            .side-bubble {
                position: fixed;
                right: 45px;
                width: 50px;
                height: 50px;
                background: var(--primary);
                color: #fff;
                border-radius: 50% 50% 0 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 28px;
                font-weight: 900;
                box-shadow: -4px 4px 15px rgba(0, 0, 0, 0.4);
                pointer-events: none;
                z-index: 3000;
                opacity: 0;
                transform: translateY(-50%) rotate(-45deg) scale(0.5);
                transition:
                    opacity 0.1s,
                    transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            }
            .side-bubble.visible {
                opacity: 1;
                transform: translateY(-50%) rotate(-45deg) scale(1);
            }
            .side-bubble span {
                transform: rotate(45deg);
                display: block;
            }

            .van-index-anchor {
                background: transparent !important;
                color: var(--primary);
                font-weight: 800;
                font-size: 18px;
                padding: 10px 0 10px 4px !important;
            }

            /* === 页面转场动画 === */
            .slide-left-enter-active,
            .slide-left-leave-active,
            .slide-right-enter-active,
            .slide-right-leave-active {
                transition:
                    transform 0.3s cubic-bezier(0.25, 0.1, 0.25, 1),
                    opacity 0.3s ease;
                z-index: 10;
            }
            .slide-left-enter-from {
                transform: translateX(100%);
                z-index: 20;
            }
            .slide-left-enter-to {
                transform: translateX(0);
                z-index: 20;
            }
            .slide-left-leave-from {
                transform: translateX(0);
                opacity: 1;
            }
            .slide-left-leave-to {
                transform: translateX(-25%);
                opacity: 0.5;
            }
            .slide-right-enter-from {
                transform: translateX(-25%);
                opacity: 0.5;
            }
            .slide-right-enter-to {
                transform: translateX(0);
                opacity: 1;
            }
            .slide-right-leave-from {
                transform: translateX(0);
                z-index: 20;
            }
            .slide-right-leave-to {
                transform: translateX(100%);
                z-index: 20;
            }

            /* 主机列表样式 */
            .sys-group {
                display: flex;
                flex-direction: column;
                gap: 20px;
                padding-bottom: 20px;
            }
            .sys-card {
                background: var(--bg-card);
                border-radius: 20px;
                overflow: hidden;
                border: 1px solid rgba(255, 255, 255, 0.05);
                box-shadow: 0 15px 35px -10px rgba(0, 0, 0, 0.3);
                display: flex;
                height: 140px;
                position: relative;
                transition: transform 0.2s;
                transform: translateZ(0);
            }
            .sys-card:active {
                transform: scale(0.96);
            }
            .sys-visual {
                width: 120px;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
                position: relative;
                overflow: hidden;
                background: linear-gradient(135deg, #2d3436, #000);
            }
            .sys-visual::after {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), transparent);
            }
            .sys-abbr {
                font-size: 28px;
                font-weight: 900;
                color: rgba(255, 255, 255, 0.95);
                text-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                z-index: 2;
                text-transform: uppercase;
            }
            .sys-count-badge {
                position: absolute;
                bottom: 6px;
                right: 6px;
                font-size: 9px;
                color: rgba(255, 255, 255, 0.9);
                font-weight: 700;
                z-index: 2;
                background: rgba(0, 0, 0, 0.4);
                padding: 1px 5px;
                border-radius: 4px;
            }
            .sys-content {
                flex: 1;
                padding: 18px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                min-width: 0;
            }
            .sys-name {
                font-size: 19px;
                font-weight: 800;
                color: #fff;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                margin-bottom: 6px;
            }
            .sys-meta {
                font-size: 12px;
                color: var(--primary);
                margin-bottom: 10px;
                font-weight: 600;
            }
            .sys-desc {
                font-size: 13px;
                color: var(--text-sub);
                display: -webkit-box;
                -webkit-line-clamp: 2;
                line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
                line-height: 1.5;
            }

            .intro-header {
                margin: 0 0 20px 0;
                padding: 24px;
                border-radius: 24px;
                color: #fff;
                box-shadow: 0 12px 30px -8px rgba(0, 0, 0, 0.4);
                position: relative;
                overflow: hidden;
                background-size: 200% 200% !important;
                animation: gradientMove 8s ease infinite;
            }
            .intro-bg-icon {
                position: absolute;
                right: -25px;
                bottom: -35px;
                font-size: 160px;
                opacity: 0.12;
                transform: rotate(-15deg);
            }
            .intro-title {
                font-size: 24px;
                font-weight: 900;
                margin-bottom: 10px;
                text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                position: relative;
                z-index: 2;
            }
            .intro-text {
                font-size: 13px;
                line-height: 1.6;
                opacity: 0.95;
                position: relative;
                z-index: 2;
                font-weight: 500;
            }

            .game-grid-section {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(105px, 1fr));
                gap: 16px;
                padding-bottom: 20px;
            }
            .game-card {
                background: var(--bg-card);
                border-radius: 14px;
                overflow: hidden;
                position: relative;
                aspect-ratio: 3/4;
                border: 1px solid rgba(255, 255, 255, 0.05);
                box-shadow: 0 8px 20px -6px rgba(0, 0, 0, 0.4);
                transform: translateZ(0);
                transition: transform 0.2s;
            }
            .game-card:active {
                transform: scale(0.95);
            }
            .thumb-box {
                width: 100%;
                height: 100%;
                position: relative;
            }
            .thumb-bg {
                position: absolute;
                width: 100%;
                height: 100%;
                object-fit: cover;
                filter: blur(15px) brightness(0.4) saturate(1.2);
                transform: scale(1.2);
            }
            .thumb-img {
                position: absolute;
                width: 100%;
                height: 100%;
                object-fit: contain;
                z-index: 2;
            }
            .no-img {
                width: 100%;
                height: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                background: #18181c;
                color: #444;
            }

            .ver-badge {
                position: absolute;
                top: 8px;
                right: 8px;
                z-index: 5;
                background: rgba(0, 0, 0, 0.75);
                backdrop-filter: blur(4px);
                color: #fff;
                font-size: 9px;
                padding: 3px 8px;
                border-radius: 6px;
                border: 1px solid rgba(255, 255, 255, 0.15);
                font-weight: bold;
            }

            .game-info-overlay {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                z-index: 5;
                background: linear-gradient(to top, rgba(0, 0, 0, 0.95) 10%, rgba(0, 0, 0, 0.6) 60%, transparent);
                padding: 30px 8px 10px;
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            .g-title {
                font-size: 12px;
                color: #fff;
                text-align: center;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                font-weight: 700;
                width: 100%;
                margin-top: 0;
            }
            .g-year {
                font-size: 10px;
                color: #bbb;
                text-align: center;
                margin-bottom: 2px;
            }
            .g-rating {
                height: 12px;
                line-height: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                margin-bottom: 2px;
            }

            .detail-popup {
                background: #121212 !important;
                display: block;
            }
            .detail-scroll-container {
                height: 100%;
                overflow-y: auto;
            }
            .swipe-area {
                height: 380px;
                background: #000;
                position: relative;
                flex-shrink: 0;
            }
            .swipe-inner {
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                position: relative;
                overflow: hidden;
            }
            .swipe-bg {
                position: absolute;
                width: 100%;
                height: 100%;
                object-fit: cover;
                filter: blur(40px) brightness(0.3);
                z-index: 1;
            }
            .swipe-img {
                max-width: 100%;
                max-height: 100%;
                z-index: 2;
                object-fit: contain;
            }
            .thumb-strip {
                display: flex;
                gap: 12px;
                padding: 20px 16px;
                background: #18181c;
                overflow-x: auto;
                border-bottom: 1px solid rgba(255, 255, 255, 0.05);
                flex-shrink: 0;
            }
            .ts-item {
                width: 64px;
                height: 64px;
                border-radius: 10px;
                overflow: hidden;
                position: relative;
                flex-shrink: 0;
                border: 2px solid transparent;
                opacity: 0.5;
                transition: all 0.2s;
            }
            .ts-item.active {
                border-color: var(--primary);
                opacity: 1;
                transform: scale(1.05);
                box-shadow: 0 0 15px rgba(112, 93, 242, 0.3);
            }
            .ts-img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }
            .d-body {
                padding: 24px;
            }
            .d-title {
                font-size: 26px;
                font-weight: 800;
                margin-bottom: 16px;
                color: #fff;
            }
            .d-tags {
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
                margin-bottom: 24px;
            }
            .tag {
                background: rgba(255, 255, 255, 0.1);
                padding: 6px 12px;
                border-radius: 8px;
                font-size: 12px;
                color: #ddd;
                display: flex;
                align-items: center;
                gap: 4px;
            }
            .d-desc {
                font-size: 15px;
                line-height: 1.7;
                color: #a0a0b0;
                margin-bottom: 30px;
                white-space: pre-wrap;
            }
            .ver-item {
                background: #25252b;
                border-radius: 16px;
                padding: 16px;
                margin-bottom: 12px;
                border: 1px solid rgba(255, 255, 255, 0.05);
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .ver-item.selected {
                border-color: var(--primary);
                background: #2d2d36;
            }
            .dl-btn {
                background: linear-gradient(135deg, #705df2, #a29bfe);
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 24px;
                font-size: 13px;
                font-weight: 700;
                display: flex;
                align-items: center;
                gap: 6px;
            }

            .log-popup {
                background: #1c1c22 !important;
                color: #ccc;
                font-family: monospace;
                padding: 20px;
                max-height: 70vh;
                overflow-y: auto;
            }
            .log-item {
                border-bottom: 1px solid rgba(255, 255, 255, 0.05);
                padding: 6px 0;
                font-size: 12px;
            }

            @keyframes gradientMove {
                0% {
                    background-position: 0% 50%;
                }
                50% {
                    background-position: 100% 50%;
                }
                100% {
                    background-position: 0% 50%;
                }
            }
            @keyframes fadeUp {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            .anim-item {
                animation: fadeUp 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
                opacity: 0;
            }
            .fade-img {
                opacity: 0;
                transition: opacity 0.5s ease-in-out;
            }
            .fade-img.loaded {
                opacity: 1;
            }
            @keyframes spin {
                from {
                    transform: rotate(0deg);
                }
                to {
                    transform: rotate(360deg);
                }
            }
            .spin-anim {
                animation: spin 1s linear infinite;
                opacity: 1;
            }
        </style>
    </head>
    <body>
        <div id="app">
            <div class="navbar">
                <div class="nav-btn" v-if="currentSystemObj" @click="handleUiBack">
                    <i class="ri-arrow-left-line"></i>
                </div>
                <div class="nav-title">{{ currentSystemObj ? currentSystemObj.fullname : 'RetroHub' }}</div>
                <div class="nav-btn" v-if="currentSystemObj" style="opacity: 0; pointer-events: none">
                    <i class="ri-search-2-line"></i>
                </div>
            </div>

            <transition :name="transitionName">
                <div class="page-container" v-if="!currentSystemObj" key="home" @scroll="handleScroll">
                    <van-index-bar
                        :index-list="systemIndexList"
                        :sticky="false"
                        highlight-color="var(--primary)"
                        @select="onIndexSelect"
                        ref="systemIndexBarRef"
                    >
                        <div v-for="(group, letter) in groupedSystems" :key="letter">
                            <van-index-anchor :index="letter">{{ letter }}</van-index-anchor>
                            <div class="sys-group">
                                <div
                                    v-for="sys in group"
                                    :key="sys.name"
                                    class="sys-card anim-item"
                                    @click="enterSystem(sys)"
                                >
                                    <div class="sys-visual" :style="{ background: getSysColor(sys.name) }">
                                        <div
                                            class="sys-abbr"
                                            :style="{ fontSize: (sys.abbr && sys.abbr.length > 5) ? '26px' : '28px' }"
                                        >
                                            {{ sys.abbr }}
                                        </div>
                                        <div class="sys-count-badge">{{ sys.count }}</div>
                                    </div>
                                    <div class="sys-content">
                                        <div class="sys-header"><div class="sys-name">{{ sys.fullname }}</div></div>
                                        <div class="sys-meta" v-if="sys.year">{{ sys.maker }} • {{ sys.year }}</div>
                                        <div class="sys-desc">{{ sys.desc }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </van-index-bar>

                    <van-empty v-if="systems.length===0" description="Library Empty" image="search" />
                </div>

                <div v-else class="page-container" key="gamelist" @scroll="handleScroll">
                    <div class="intro-header" :style="{ background: getSysColor(currentSystemObj.name) }">
                        <i class="ri-gamepad-fill intro-bg-icon"></i>
                        <div class="intro-title">{{ currentSystemObj.fullname }}</div>
                        <div class="intro-text">{{ currentSystemObj.history }}</div>
                    </div>

                    <div style="display: flex; align-items: center; margin-bottom: 10px; gap: 10px">
                        <van-search
                            v-model="keyword"
                            placeholder="Find your memory..."
                            shape="round"
                            background="transparent"
                            style="flex: 1; padding: 0"
                            @search="onSearch"
                            @clear="onClearSearch"
                        ></van-search>
                        <div
                            @click="viewLogs"
                            style="
                                background: rgba(255, 255, 255, 0.1);
                                padding: 8px;
                                border-radius: 50%;
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            "
                        >
                            <i class="ri-file-list-2-line" style="color: #bbb; font-size: 20px"></i>
                        </div>
                        <div
                            @click="triggerSync"
                            style="
                                background: rgba(255, 255, 255, 0.1);
                                padding: 8px;
                                border-radius: 50%;
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            "
                        >
                            <i
                                class="ri-refresh-line"
                                :class="{ 'spin-anim': isSyncing }"
                                style="color: var(--primary); font-size: 20px"
                            ></i>
                        </div>
                    </div>

                    <van-loading v-if="loading" vertical style="padding: 100px 0; color: #666"
                        >Loading Index...</van-loading
                    >

                    <van-index-bar
                        v-else
                        :index-list="indexList"
                        :sticky="false"
                        highlight-color="var(--primary)"
                        @select="onIndexSelect"
                        ref="gameIndexBarRef"
                    >
                        <div v-for="(group, letter) in groupedGames" :key="letter">
                            <van-index-anchor :index="letter">{{ letter }}</van-index-anchor>
                            <div class="game-grid-section">
                                <div v-for="game in group" :key="game.name" class="game-card" @click="openDetail(game)">
                                    <div class="thumb-box">
                                        <div v-if="!game.image_path" class="no-img">
                                            <i class="ri-gamepad-line" style="font-size: 32px"></i>
                                        </div>
                                        <template v-else>
                                            <img
                                                class="thumb-bg fade-img"
                                                :src="getImgUrl(game.image_path)"
                                                loading="lazy"
                                                @load="onImgLoad"
                                            />
                                            <img
                                                class="thumb-img fade-img"
                                                :src="getImgUrl(game.image_path)"
                                                loading="lazy"
                                                @load="onImgLoad"
                                            />
                                        </template>
                                        <div class="ver-badge" v-if="game.version_count > 1">
                                            {{ game.version_count }} Ver
                                        </div>
                                        <div class="game-info-overlay">
                                            <div class="g-rating" v-if="game.rating && game.rating > 0">
                                                <van-rate
                                                    :model-value="Number(game.rating) * 5"
                                                    readonly
                                                    allow-half
                                                    size="10px"
                                                    gutter="2px"
                                                    color="#ffd21e"
                                                    void-icon="star"
                                                    void-color="#555"
                                                />
                                            </div>
                                            <div class="g-year">
                                                {{ game.releasedate ? game.releasedate.substring(0,4) : '' }}
                                            </div>
                                            <div class="g-title">{{ game.name }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </van-index-bar>
                    <div style="height: 40px"></div>
                </div>
            </transition>

            <div
                class="index-hint"
                :class="{ 'active-scroll': isScrollingPage }"
                :style="{ top: indicatorTop + 'px', transform: 'none' }"
            ></div>
            <div class="side-bubble" :class="{ visible: showLetterToast }" :style="{ top: bubbleY + 'px' }">
                <span>{{ currentLetter }}</span>
            </div>

            <van-popup
                :show="showDetail"
                @update:show="handlePopupClose"
                position="bottom"
                round
                closeable
                class="detail-popup"
                :style="{ height: '95%' }"
            >
                <div v-if="selectedGame" class="detail-scroll-container">
                    <div class="swipe-area">
                        <van-swipe
                            ref="imgSwipe"
                            :autoplay="0"
                            indicator-color="white"
                            style="height: 100%"
                            @change="onSwipeChange"
                        >
                            <template v-if="displayImages.length > 0">
                                <van-swipe-item v-for="(img, idx) in displayImages" :key="idx" @click="previewBig(idx)">
                                    <div class="swipe-inner">
                                        <img class="swipe-bg fade-img" :src="getImgUrl(img.url)" @load="onImgLoad" />
                                        <img class="swipe-img fade-img" :src="getImgUrl(img.url)" @load="onImgLoad" />
                                    </div>
                                </van-swipe-item>
                            </template>
                            <van-swipe-item v-else
                                ><div class="swipe-inner" style="background: #111; color: #555; flex-direction: column">
                                    <i class="ri-image-line" style="font-size: 50px"></i><span>No Preview</span>
                                </div></van-swipe-item
                            >
                        </van-swipe>
                    </div>
                    <div class="thumb-strip" v-if="displayImages.length > 1">
                        <div
                            v-for="(img, idx) in displayImages"
                            :key="idx"
                            class="ts-item"
                            :class="{ active: currentSwipeIndex === idx }"
                            @click="swipeTo(idx)"
                        >
                            <img class="ts-img fade-img" :src="getImgUrl(img.url)" @load="onImgLoad" />
                        </div>
                    </div>
                    <div class="d-body">
                        <div class="d-title">{{ selectedGame.name }}</div>
                        <div class="d-tags">
                            <span class="tag" v-if="selectedGame.releasedate"
                                >{{ selectedGame.releasedate.substring(0,4) }}</span
                            >
                            <span class="tag" v-if="selectedGame.genre">{{ selectedGame.genre }}</span>
                            <span class="tag" v-if="selectedGame.players"
                                ><i class="ri-user-3-fill"></i> {{ selectedGame.players }}</span
                            >
                            <span class="tag" v-if="selectedGame.publisher">{{ selectedGame.publisher }}</span>
                            <span class="tag" v-if="selectedGame.developer">{{ selectedGame.developer }}</span>
                        </div>
                        <div style="margin-bottom: 16px" v-if="selectedGame.rating > 0">
                            <van-rate
                                :model-value="Number(selectedGame.rating) * 5"
                                readonly
                                allow-half
                                color="#ffd21e"
                                void-icon="star"
                                void-color="#333"
                            />
                        </div>
                        <div class="d-desc">{{ selectedGame.desc || '暂无描述信息。' }}</div>
                        <van-divider content-position="left" style="border-color: rgba(255, 255, 255, 0.1)"
                            >Available Files ({{ versions.length }})</van-divider
                        >
                        <div
                            class="ver-item"
                            v-for="ver in versions"
                            :key="ver.id"
                            :class="{ selected: currentVersionId === ver.id }"
                            @click="switchVersion(ver)"
                        >
                            <div style="flex: 1; min-width: 0; padding-right: 10px">
                                <div class="v-file">{{ ver.filename }}</div>
                            </div>
                            <button class="dl-btn" @click.stop="download(ver.id)">
                                <i class="ri-download-cloud-2-line"></i> GET
                            </button>
                        </div>
                        <div style="height: 40px"></div>
                    </div>
                </div>
            </van-popup>

            <van-popup
                :show="showLogPopup"
                @click-overlay="handleLogClose"
                position="bottom"
                round
                class="log-popup"
                :style="{ height: '60%' }"
            >
                <div style="text-align: center; margin-bottom: 10px; font-weight: bold; color: #fff">
                    Running Logs
                    <span v-if="isSyncing && progress.total > 0">({{ progress.current }} / {{ progress.total }})</span>
                </div>
                <div v-if="logs.length === 0" style="text-align: center; padding: 20px; color: #666">
                    No logs available.
                </div>
                <div v-for="(log, i) in logs" :key="i" class="log-item">{{ log }}</div>
            </van-popup>
        </div>

        <script src="https://fastly.jsdelivr.net/npm/vue@3"></script>
        <script src="https://fastly.jsdelivr.net/npm/vant@4/lib/vant.min.js"></script>

        <script>
            const { createApp, ref, computed, onMounted, nextTick } = Vue;

            const app = createApp({
                setup() {
                    const systems = ref([]);
                    const currentSystemObj = ref(null);
                    const allGames = ref([]);
                    const loading = ref(false);
                    const showSearch = ref(false);
                    const keyword = ref('');
                    const showDetail = ref(false);
                    const selectedGame = ref(null);
                    const versions = ref([]);
                    const currentVersionId = ref(null);
                    const currentSwipeIndex = ref(0);
                    const imgSwipe = ref(null);
                    const isPreviewOpen = ref(false);
                    const isSyncing = ref(false);
                    const showLogPopup = ref(false);
                    const logs = ref([]);
                    // 【新增】进度状态
                    const progress = ref({ current: 0, total: 0 });

                    const showLetterToast = ref(false);
                    const currentLetter = ref('');
                    const bubbleY = ref(0);
                    const isTouchingIndex = ref(false);
                    const isScrollingPage = ref(false);
                    let scrollTimeout = null;

                    /* 索引栏引用 */
                    const systemIndexBarRef = ref(null);
                    const gameIndexBarRef = ref(null);

                    /* 【JS控制】指示器动态位置，初始位置放在安全的顶部 */
                    const indicatorTop = ref(70); // 70px

                    // 缓存 sidebar 几何信息，避免重复计算
                    let sidebarRectCache = null;
                    let animationFrameId = null;

                    let statusPollTimer = null;
                    const transitionName = ref('slide-left');

                    const fetchSystems = async () => {
                        try {
                            const res = await fetch('/api/systems');
                            systems.value = await res.json();
                            // 【新增】数据加载完成后，立即触发一次布局计算，防止索引位置错乱
                            nextTick(() => updateLayoutFromScroll());
                        } catch (e) {
                            console.error(e);
                        }
                    };

                    const pollStatus = async () => {
                        if (!currentSystemObj.value) return;
                        try {
                            const res = await fetch(`/api/status/${currentSystemObj.value.name}`);
                            const data = await res.json();
                            isSyncing.value = data.syncing;
                            logs.value = data.logs.reverse();
                            // 【新增】更新进度
                            if (data.progress) {
                                progress.value = data.progress;
                            }
                            if (isSyncing.value || showLogPopup.value) {
                                if (statusPollTimer) clearTimeout(statusPollTimer);
                                statusPollTimer = setTimeout(pollStatus, 2000);
                            }
                        } catch (e) {
                            console.error(e);
                        }
                    };

                    const loadGames = async (sysObj) => {
                        loading.value = true;
                        allGames.value = [];
                        try {
                            const res = await fetch(`/api/games?system=${sysObj.name}&all=1`);
                            const data = await res.json();
                            allGames.value = data.data;
                            // 【新增】数据加载完成后，立即触发一次布局计算
                            nextTick(() => updateLayoutFromScroll());
                        } finally {
                            loading.value = false;
                        }
                    };

                    const enterSystem = async (sysObj) => {
                        transitionName.value = 'slide-left';
                        window.history.pushState({ page: 'gamelist', systemName: sysObj.name }, '');
                        currentSystemObj.value = sysObj;
                        // 切换页面时，滚动条位置会归零，强制重置指示器位置
                        indicatorTop.value = 70;
                        pollStatus();
                        loadGames(sysObj);
                    };

                    const handleUiBack = () => {
                        if (currentSystemObj.value && !showDetail.value && !showLogPopup.value) {
                            if (window.history.state && window.history.state.page === 'gamelist') {
                                if (window.history.length <= 2) {
                                    transitionName.value = 'slide-right';
                                    currentSystemObj.value = null;
                                    window.history.replaceState({ page: 'home' }, '');
                                    indicatorTop.value = 70; // 重置
                                    return;
                                }
                            }
                        }
                        window.history.back();
                    };

                    /* 【JS控制】独立出的位置计算逻辑 */
                    const updateLayoutFromScroll = () => {
                        const container = document.querySelector('.page-container');
                        if (!container) return;

                        const scrollTop = container.scrollTop;
                        const scrollHeight = container.scrollHeight;
                        const clientHeight = container.clientHeight;

                        const scrollRange = scrollHeight - clientHeight;
                        const ratio = scrollRange > 0 ? scrollTop / scrollRange : 0;

                        const safeTop = 66;
                        const safeBottomPadding = 20;
                        const indicatorHeight = 40;
                        const viewHeight = window.innerHeight;
                        const trackLength = viewHeight - safeTop - safeBottomPadding - indicatorHeight;
                        const currentIndTop = safeTop + ratio * trackLength;

                        indicatorTop.value = currentIndTop;

                        const sidebar = document.querySelector('.van-index-bar__sidebar');
                        if (sidebar) {
                            const sbHeight = sidebar.offsetHeight;
                            let targetSidebarTop = currentIndTop + indicatorHeight / 2 - sbHeight / 2;
                            const minSidebarTop = 70;
                            const maxSidebarTop = viewHeight - sbHeight - 10;
                            targetSidebarTop = Math.max(minSidebarTop, Math.min(targetSidebarTop, maxSidebarTop));
                            document.body.style.setProperty('--sidebar-top', `${targetSidebarTop}px`);
                        }
                    };

                    /* 【JS控制】核心滚动监听 */
                    const handleScroll = (e) => {
                        isScrollingPage.value = true;
                        if (scrollTimeout) clearTimeout(scrollTimeout);
                        scrollTimeout = setTimeout(() => {
                            isScrollingPage.value = false;
                        }, 1000);

                        if (!isTouchingIndex.value) {
                            updateLayoutFromScroll();
                        }
                    };

                    const handleIndexTouch = (e) => {
                        if (e.type === 'touchstart') {
                            const isHint = e.target.classList.contains('index-hint');
                            if (!isHint) return;

                            isTouchingIndex.value = true;
                            document.body.classList.add('touching-sidebar');
                            e.preventDefault();

                            // 缓存 sidebar 信息
                            const sidebar = document.querySelector('.van-index-bar__sidebar');
                            if (sidebar) {
                                const rect = sidebar.getBoundingClientRect();
                                const indexCount = (currentSystemObj.value ? indexList.value : systemIndexList.value)
                                    .length;
                                sidebarRectCache = {
                                    top: rect.top,
                                    height: rect.height,
                                    itemHeight: rect.height / indexCount,
                                    list: currentSystemObj.value ? indexList.value : systemIndexList.value
                                };
                            }
                        }

                        if (isTouchingIndex.value) {
                            e.preventDefault();

                            if (e.type === 'touchend' || e.type === 'touchcancel') {
                                isTouchingIndex.value = false;
                                document.body.classList.remove('touching-sidebar');
                                setTimeout(() => (showLetterToast.value = false), 300);
                                if (animationFrameId) cancelAnimationFrame(animationFrameId);
                                updateLayoutFromScroll(); // 强制归位
                                return;
                            }

                            // 使用 requestAnimationFrame 节流
                            if (animationFrameId) cancelAnimationFrame(animationFrameId);
                            animationFrameId = requestAnimationFrame(() => {
                                const touch = e.touches[0];
                                bubbleY.value = touch.clientY;

                                if (sidebarRectCache && sidebarRectCache.list.length > 0) {
                                    // 纯数学计算：(触摸点Y - 侧边栏顶部Y) / 单个字母高度
                                    const relativeY = touch.clientY - sidebarRectCache.top;
                                    let index = Math.floor(relativeY / sidebarRectCache.itemHeight);

                                    // 边界检查
                                    index = Math.max(0, Math.min(index, sidebarRectCache.list.length - 1));

                                    const char = sidebarRectCache.list[index];
                                    if (char && char !== currentLetter.value) {
                                        currentLetter.value = char;
                                        showLetterToast.value = true;
                                        const activeBar = currentSystemObj.value
                                            ? gameIndexBarRef.value
                                            : systemIndexBarRef.value;
                                        if (activeBar) {
                                            activeBar.scrollTo(char);
                                        }
                                    }
                                }
                            });
                        }
                    };

                    const onIndexSelect = (index) => {
                        if (isTouchingIndex.value) {
                            currentLetter.value = index;
                            showLetterToast.value = true;
                        }
                    };

                    window.addEventListener('popstate', (event) => {
                        const state = event.state;
                        if (isPreviewOpen.value) {
                            isPreviewOpen.value = false;
                            vant.closeImagePreview();
                            return;
                        }
                        const targetPage = state && state.page ? state.page : 'home';

                        if (targetPage === 'gamelist') {
                            showLogPopup.value = false;
                            showDetail.value = false;
                            if (!currentSystemObj.value && state.systemName) {
                                transitionName.value = 'slide-left';
                                const sys = systems.value.find((s) => s.name === state.systemName);
                                if (sys) {
                                    currentSystemObj.value = sys;
                                    loadGames(sys);
                                    pollStatus();
                                }
                            }
                        } else if (targetPage === 'home') {
                            showLogPopup.value = false;
                            showDetail.value = false;
                            transitionName.value = 'slide-right';
                            currentSystemObj.value = null;
                            showSearch.value = false;
                            allGames.value = [];
                            indicatorTop.value = 70; // 重置
                        } else if (targetPage === 'detail') {
                            showDetail.value = true;
                            showLogPopup.value = false;
                        } else if (targetPage === 'log') {
                            showLogPopup.value = true;
                        }
                    });

                    onMounted(() => {
                        fetchSystems();
                        window.history.replaceState({ page: 'home' }, '');

                        window.addEventListener('touchstart', handleIndexTouch, { passive: false });
                        window.addEventListener('touchmove', handleIndexTouch, { passive: false });
                        window.addEventListener('touchend', handleIndexTouch);

                        // 【新增】首次加载后的兜底计算
                        setTimeout(() => updateLayoutFromScroll(), 500);
                    });

                    const openDetail = async (game) => {
                        window.history.pushState(
                            { page: 'detail', systemName: currentSystemObj.value.name, gameName: game.name },
                            ''
                        );
                        selectedGame.value = game;
                        currentSwipeIndex.value = 0;
                        showDetail.value = true;
                        nextTick(() => {
                            if (imgSwipe.value) imgSwipe.value.swipeTo(0, { immediate: true });
                        });
                        versions.value = [];
                        currentVersionId.value = null;
                        const res = await fetch(
                            `/api/game-versions?system=${currentSystemObj.value.name}&name=${encodeURIComponent(game.name)}`
                        );
                        versions.value = await res.json();
                        if (versions.value.length > 0) currentVersionId.value = versions.value[0].id;
                    };
                    const viewLogs = () => {
                        window.history.pushState({ page: 'log', systemName: currentSystemObj.value?.name }, '');
                        showLogPopup.value = true;
                        pollStatus();
                    };

                    const triggerSync = async () => {
                        if (isSyncing.value) {
                            viewLogs();
                            return;
                        }
                        vant.showConfirmDialog({
                            title: '同步文件',
                            message: '扫描并联网抓取信息。'
                        })
                            .then(async () => {
                                isSyncing.value = true;
                                logs.value = [];
                                // 重置前端进度显示
                                progress.value = { current: 0, total: 0 };
                                await fetch(`/api/scan/${currentSystemObj.value.name}`, { method: 'POST' });
                                vant.showToast({ message: '后台扫描已启动', icon: 'success' });
                                pollStatus();
                            })
                            .catch(() => {});
                    };

                    const handlePopupClose = (val) => {
                        if (val === false) window.history.back();
                    };
                    const handleLogClose = () => window.history.back();
                    const switchVersion = (ver) => {
                        currentVersionId.value = ver.id;
                        if (imgSwipe.value) imgSwipe.value.swipeTo(0);
                    };
                    const swipeTo = (idx) => {
                        if (imgSwipe.value) imgSwipe.value.swipeTo(idx);
                    };
                    const onSwipeChange = (idx) => (currentSwipeIndex.value = idx);
                    const previewBig = (startIdx) => {
                        window.history.pushState({ page: 'preview' }, '');
                        isPreviewOpen.value = true;
                        vant.showImagePreview({
                            images: displayImages.value.map((i) => getImgUrl(i.url)),
                            startPosition: startIdx,
                            closeable: true,
                            onClose: () => {
                                if (isPreviewOpen.value) window.history.back();
                            }
                        });
                    };
                    const getSysColor = (sysName) => {
                        const colors = [
                            'linear-gradient(135deg, #ff5e57, #d63031)',
                            'linear-gradient(135deg, #a29bfe, #6c5ce7)',
                            'linear-gradient(135deg, #00b894, #00cec9)',
                            'linear-gradient(135deg, #fdcb6e, #e17055)',
                            'linear-gradient(135deg, #74b9ff, #0984e3)',
                            'linear-gradient(135deg, #636e72, #2d3436)'
                        ];
                        let hash = 0;
                        for (let i = 0; i < sysName.length; i++) hash = sysName.charCodeAt(i) + ((hash << 5) - hash);
                        return colors[Math.abs(hash) % colors.length];
                    };
                    const getImgUrl = (path) =>
                        path
                            ? '/' +
                              path
                                  .split('/')
                                  .map((p) => encodeURIComponent(p))
                                  .join('/')
                            : '';
                    const onImgLoad = (e) => e.target.classList.add('loaded');
                    const download = (id) => (window.location.href = `/api/download/${id}`);

                    const groupedGames = computed(() => {
                        if (!allGames.value.length) return {};
                        const groups = {};
                        allGames.value.forEach((game) => {
                            let letter = (game.name || '#')[0].toUpperCase();
                            if (!/[A-Z]/.test(letter)) letter = '#';
                            if (!groups[letter]) groups[letter] = [];
                            groups[letter].push(game);
                        });
                        return Object.keys(groups)
                            .sort()
                            .reduce((obj, key) => {
                                obj[key] = groups[key];
                                return obj;
                            }, {});
                    });
                    const indexList = computed(() => Object.keys(groupedGames.value));

                    const groupedSystems = computed(() => {
                        if (!systems.value.length) return {};
                        const groups = {};
                        systems.value.forEach((sys) => {
                            let letter = (sys.fullname || sys.name || '#')[0].toUpperCase();
                            if (!/[A-Z]/.test(letter)) letter = '#';
                            if (!groups[letter]) groups[letter] = [];
                            groups[letter].push(sys);
                        });
                        return Object.keys(groups)
                            .sort()
                            .reduce((obj, key) => {
                                obj[key] = groups[key];
                                return obj;
                            }, {});
                    });
                    const systemIndexList = computed(() => Object.keys(groupedSystems.value));

                    const displayImages = computed(() => {
                        if (!currentVersionId.value) return [];
                        const ver = versions.value.find((v) => v.id === currentVersionId.value);
                        if (!ver) return [];
                        if (!ver.gallery || ver.gallery.length === 0) {
                            if (selectedGame.value.image_path)
                                return [{ type: 'Cover', url: selectedGame.value.image_path }];
                            return [];
                        }
                        return ver.gallery;
                    });

                    return {
                        systems,
                        currentSystemObj,
                        loading,
                        showSearch,
                        keyword,
                        groupedGames,
                        indexList,
                        showDetail,
                        selectedGame,
                        versions,
                        currentVersionId,
                        displayImages,
                        currentSwipeIndex,
                        imgSwipe,
                        enterSystem,
                        handleUiBack,
                        openDetail,
                        switchVersion,
                        swipeTo,
                        onSwipeChange,
                        previewBig,
                        getSysColor,
                        getImgUrl,
                        download,
                        onImgLoad,
                        triggerSync,
                        isSyncing,
                        showLogPopup,
                        logs,
                        viewLogs,
                        handlePopupClose,
                        handleLogClose,
                        onSearch: () => {},
                        onClearSearch: () => {},
                        showLetterToast,
                        currentLetter,
                        bubbleY,
                        transitionName,
                        isTouchingIndex,
                        onIndexSelect,
                        groupedSystems,
                        systemIndexList,
                        handleScroll,
                        isScrollingPage,
                        systemIndexBarRef,
                        gameIndexBarRef,
                        indicatorTop,
                        progress // 导出 progress
                    };
                }
            });

            app.use(vant);
            app.mount('#app');
        </script>
    </body>
</html>
